<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ENS Display Name</title>
<style>
.hide {
	display: none;
}
.arrows {
	width: 3rem;
	padding-bottom: 100%;
	animation: spin 2s infinite linear;
	user-select: none;
	background-image: url('data:image/svg+xml;utf8,%3Csvg%20viewBox%3D%220%200%201000%201000%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M990%2C377.5H622.5l137.4-137.4C690.4%2C170.7%2C598.2%2C132.5%2C500%2C132.5c-98.2%2C0-190.4%2C38.2-259.9%2C107.6C170.7%2C309.6%2C132.5%2C401.8%2C132.5%2C500c0%2C98.2%2C38.2%2C190.4%2C107.6%2C259.9c69.4%2C69.4%2C161.7%2C107.6%2C259.9%2C107.6c98.2%2C0%2C190.4-38.2%2C259.9-107.6c5.8-5.8%2C11.4-11.8%2C16.7-17.9l92.2%2C80.7C778.9%2C925.2%2C647%2C990%2C500%2C990C229.4%2C990%2C10%2C770.6%2C10%2C500C10%2C229.4%2C229.4%2C10%2C500%2C10c135.3%2C0%2C257.8%2C54.9%2C346.5%2C143.5L990%2C10V377.5z%22%2F%3E%3C%2Fsvg%3E');
	background-repeat: no-repeat;
	background-size: contain;
}
@keyframes spin {
	from { transform:rotate(0deg); }
	to	 { transform:rotate(360deg); }
}
body {
	margin: 3rem;
	background: #eee;
}
header {
	display: flex;
}
h1 {
	margin: 0;
	white-space: pre;
	flex-grow: 1;
}
#version {
	text-align: right;
}
#examples {
	margin: 0.5rem 0;
	display: flex;
	flex-wrap: wrap;
	gap: 0.2rem;
	align-items: center;
}
#input {
	margin-top: 1rem;
	display: flex;
	align-items: center;
	gap: 1rem;
}
#input_field {
	font-size: 24pt;
	box-sizing: border-box;
	flex: 100%;
	padding: 1rem;
	border: 2px solid #333;
	border-radius: 0.5rem;
}
.working {
	background: #fff;
}
.norm {
	background-color: #cfc;
}
.display {
	background-color: #cff;
}
#input_field.address {
	font-size: 14pt;
}
.address {
	font-family: monospace;
	background: #ffc;
}
.unnorm {
	background-color: #fc9;
}
.invalid {
	background-color: #f66;
}
#key {
	margin: 0.5rem 0;
	display: flex;
	flex-wrap: wrap;
	align-items: stretch;
	gap: 0.2rem;
}
#key > * {
	padding: 0.2rem 0.5rem;
	border: 1px solid #aaa;
	border-radius: 0.5rem;
	display: flex;
	align-items: center;
}
#output_div {
	display: flex;
	flex-direction: column;
	align-items: center;
}
#output_div > * {
	margin-top: 0.5rem;
}
#error {
	text-align: center;
	font-size: 14pt;
}
#output_div button {
	font-size: 14pt;
	padding: 0.2rem 0.5rem;
}
#address {
	display: flex;
	flex-wrap: wrap;
	gap: 0.5rem;
	justify-content: center;
}
#address a {
	font-size: 12pt;
	font-family: monospace;
	line-break: anywhere;
	padding: 0.5rem;
	border: 1px solid #aaa;
	border-radius: 0.5rem;
}
@media only screen and (max-width: 800px) { 
	body {
		margin: 1rem;
	}
	button {
		font-size: 100%;
	}
}
</style>
</head>
<body>
<header>
<h1>ENS Display Name</h1>
<div id="version"><a href="https://github.com/adraffy/eth-tools.js">@adraffy/eth-tools.js</a></div>
</header>
<div id="key">
<span class="display">Display</span>
<span class="norm">Normalized</span>
<span class="unnorm">Unnormalized</span>
<span class="address">Address</span>
<span class="invalid">Invalid</span>
</div>
<div id="examples">
<button>ADRaffy.eth</button>
<button>adraffy.eth</button>
<button>aDrAfFy.eTh</button>
<button data-input="0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045">0xd8dA..6045</button>
<button>adraffy?eth</button>
<button>adraffyeth</button>
</div>
<div id="input">
<input id="input_field" placeholder="ENS Name">
<div id="arrows" class="hide"><div class="arrows"></div></div>
</div>
<div id="output_div"></div>
<script type="module">
import {ens_normalize} from '../dist/ens-normalize-debug.js';
import {
	FetchProvider, Providers, 
	determine_window_provider, ENS,
	is_valid_address
} from '../../eth-tools.js/dist/eth-tools.js';

const providers = new Providers()
	.add_static(1, new FetchProvider({url: 'https://mainnet.infura.io/v3/f36f6a8638134ac09f9400d3a7008dfe'}));

determine_window_provider().then(p => {
	providers.add_dynamic(p);
}).catch(() => {});

const ens = new ENS({provider: providers.view(1), ens_normalize});

const input_field = document.querySelector('#input_field');
const output_div = document.querySelector('#output_div');
const arrows = document.querySelector('#arrows');

let update_timer;
let dirty = false;

input_field.addEventListener('input', mark_dirty);
input_field.addEventListener('keydown', e => {
	if (e.key === 'Enter') {
		document.querySelector('#resolve_btn')?.click();
	}
});
for (let el of document.querySelectorAll('#examples button')) {
	el.addEventListener('click', () => {
		input_field.value = el.dataset.input ?? el.innerHTML;
		mark_dirty();
	});
}
if (input_field.value) mark_dirty();

function mark_dirty() {
	dirty = true;
	output_div.innerHTML = '';
	update();
}

function update() {
	if (!dirty || update_timer) return;
	update_timer = setTimeout(resolve, 500);
	arrows.classList.remove('hide');	
	remove_classes(input_field);
	input_field.classList.add('working');
}

function remove_classes(x) {
	x.classList.remove(...x.classList);
}

async function resolve() {
	dirty = false;
	clearTimeout(update_timer);
	output_div.innerHTML = '';
	let input = input_field.value.trim();
	try {
		if (is_valid_address(input)) {
			input_field.classList.add('address');
			let owner = ens.owner(input);
			let reverse = await owner.get_primary_name();
			if (reverse) {
				let btn = document.createElement('button');
				btn.id = 'resolve_btn';
				btn.innerHTML = `Resolve: <b>${reverse}</b>`;
				btn.addEventListener('click', () => {
					input_field.value = reverse;
					mark_dirty();
				});
				output_div.append(btn);
			} else {
				output_div.innerHTML = `<div class="error">❌ <b>Reverse Name</b></div>`; 
			}
		} else if (input) {
			let name = await ens.resolve(input);
			if (name.is_input_normalized()) {
				input_field.classList.add('norm');
			} else if (await name.is_input_display().catch(err => {
				output_div.innerHTML = `<div class="error">⚠️ <b>${err.message}</b></div>`;
				return false;
			})) {
				remove_classes(input_field);
				input_field.classList.add('display');
			} else {
				input_field.classList.add('unnorm');
			}
			let address = await name.get_address().catch(err => {
				output_div.innerHTML += `<div class="error">⚠️ <b>${err.message}</b></div>`;
			});
			if (address) {
				let div = document.createElement('div');
				div.id = 'address';
				div.innerHTML = `<a class="address" href="https://etherscan.io/address/${address}">${address}</a>`;
				let btn = document.createElement('button');
				btn.innerHTML = 'Copy';
				btn.addEventListener('click', () => navigator.clipboard.writeText(address));
				div.append(btn);
				output_div.append(div);
			}
		}
	} catch (err) {
		if (err.isInvalid) {
			input_field.classList.add('invalid');
			output_div.innerHTML = `<div class="error">❌ <b>${err.cause.message}</b></div>`;
		} else {
			output_div.innerHTML = `<div class="error">❌ <b>${err.message}</b></div>`;
		}		
	}
	input_field.classList.remove('working');
	arrows.classList.add('hide');
	update_timer = false;
	if (dirty) update();
}
</script>
</body>
</html>