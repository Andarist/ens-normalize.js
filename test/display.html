<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ENS Display Name</title>
<style>
.hide {
	display: none !important;
}
.arrows {
	width: 3rem;
	padding-bottom: 100%;
	animation: spin 2s infinite linear;
	user-select: none;
	background-image: url('data:image/svg+xml;utf8,%3Csvg%20viewBox%3D%220%200%201000%201000%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M990%2C377.5H622.5l137.4-137.4C690.4%2C170.7%2C598.2%2C132.5%2C500%2C132.5c-98.2%2C0-190.4%2C38.2-259.9%2C107.6C170.7%2C309.6%2C132.5%2C401.8%2C132.5%2C500c0%2C98.2%2C38.2%2C190.4%2C107.6%2C259.9c69.4%2C69.4%2C161.7%2C107.6%2C259.9%2C107.6c98.2%2C0%2C190.4-38.2%2C259.9-107.6c5.8-5.8%2C11.4-11.8%2C16.7-17.9l92.2%2C80.7C778.9%2C925.2%2C647%2C990%2C500%2C990C229.4%2C990%2C10%2C770.6%2C10%2C500C10%2C229.4%2C229.4%2C10%2C500%2C10c135.3%2C0%2C257.8%2C54.9%2C346.5%2C143.5L990%2C10V377.5z%22%2F%3E%3C%2Fsvg%3E');
	background-repeat: no-repeat;
	background-size: contain;
}
@keyframes spin {
	from { transform:rotate(0deg); }
	to	 { transform:rotate(360deg); }
}
body {
	margin: 3rem;
	background: #eee;
}
header {
	display: flex;
}
h1 {
	margin: 0;
	flex-grow: 1;
	white-space: pre;
}
.small {
	font-size: 16pt;
}
#provider {
	font-size: 10pt;
	color: #666;
}
#version {
	text-align: right;
	display: flex;
	flex-direction: column;
	gap: 0.2rem;
}
#network {
	margin-top: 0.5rem;
	display: flex;
	gap: 0.5rem;
	flex-wrap: wrap;
	align-items: center;
}
#network select {
	font-size: 100%;
}
#network .switching .arrows {
	width: 1rem;
}
#examples {
	margin: 0.5rem 0;
	display: flex;
	flex-wrap: wrap;
	gap: 0.2rem;
	align-items: center;
}
#input {
	margin-top: 1rem;
	display: flex;
	align-items: center;
	gap: 1rem;
}
#input_field {
	font-size: 24pt;
	box-sizing: border-box;
	flex: 100%;
	padding: 1rem;
	border: 2px solid #333;
	border-radius: 0.5rem;
}
.working {
	background: #fff;
}
.norm {
	background-color: #cfc;
}
.display {
	background-color: #cff;
}
#input_field.address {
	font-size: 14pt;
}
.address {
	font-family: monospace;
	background: #ffc;
}
.unnorm {
	background-color: #fc9;
}
.invalid {
	background-color: #f66;
}
#key {
	margin: 0.5rem 0;
	display: flex;
	flex-wrap: wrap;
	align-items: stretch;
	gap: 0.2rem;
}
#key > * {
	padding: 0.2rem 0.5rem;
	border: 1px solid #aaa;
	border-radius: 0.5rem;
	display: flex;
	align-items: center;
}
#output_div {
	display: flex;
	flex-direction: column;
	align-items: center;
}
#output_div > * {
	margin-top: 0.5rem;
}
#error {
	text-align: center;
	font-size: 14pt;
}
#output_div button {
	font-size: 14pt;
	padding: 0.2rem 0.5rem;
}
#address {
	display: flex;
	flex-wrap: wrap;
	gap: 0.5rem;
	justify-content: center;
}
#address a {
	font-size: 12pt;
	font-family: monospace;
	line-break: anywhere;
	padding: 0.5rem;
	border: 1px solid #aaa;
	border-radius: 0.5rem;
}
#txs {
	display: flex;
	flex-direction: column;
	align-items: center;
}
.tx {
	margin-top: 1rem;
	display: flex;
	align-items: center;
	gap: 0.5rem;
	background: #fff;
	padding: 0.5rem;
	border-radius: 1rem;
}
.tx .arrows {
	width: 1.5rem;
}
@media only screen and (max-width: 800px) { 
	body {
		margin: 1rem;
	}
	button {
		font-size: 100%;
	}
}
</style>
</head>
<body>
<header>
<h1><a href="https://ens.domains/">ENS</a> Display Name <span class="small">(<a href="https://eips.ethereum.org/EIPS/eip-634">EIP-634</a>)</span></h1>
<div id="version">
<a href="https://github.com/adraffy/ens-normalize.js">@adraffy/ens-normalize.js</a>
<a href="https://github.com/adraffy/eth-tools.js">@adraffy/eth-tools.js</a>
</div>
</header>
<div id="network">
<div class="switching"><div class="arrows"></div></div>
<select></select>
<button id="switch_default_btn" class="hide">Switch</button>
<button id="pair_btn" class="hide">Pair</button>
<span id="provider">Waiting for wallet...</span>
</div>
<div id="key">
<span class="display">Display</span>
<span class="norm">Normalized</span>
<span class="unnorm">Unnormalized</span>
<span class="address">Address</span>
<span class="invalid">Invalid</span>
</div>
<div id="examples">
<button>ADRaffy.eth</button>
<button>adraffy.eth</button>
<button>aDrAfFy.eTh</button>
<button data-input="0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045">0xd8dA..6045</button>
<button>adraffy?eth</button>
<button>adraffyeth</button>
</div>
<div id="input">
<input id="input_field" placeholder="ENS Name">
<div id="arrows" class="hide"><div class="arrows"></div></div>
</div>
<div id="output_div"></div>
<div id="txs"></div>
<script type="module">
import {ens_normalize} from '../dist/ens-normalize-debug.js';
import {
	WebSocketProvider, Providers, 
	determine_window_provider, ENS,
	is_valid_address, short_address, 
	find_chain, ensure_chain, ABIEncoder
} from '../../eth-tools.js/dist/eth-tools.js';

const providers = new Providers()
	.add_static(1, new WebSocketProvider({url: 'wss://mainnet.infura.io/ws/v3/f36f6a8638134ac09f9400d3a7008dfe'}))
	.add_static(3, new WebSocketProvider({url: 'wss://ropsten.infura.io/ws/v3/f36f6a8638134ac09f9400d3a7008dfe'}))
	.add_static(4, new WebSocketProvider({url: 'wss://rinkeby.infura.io/ws/v3/f36f6a8638134ac09f9400d3a7008dfe'}))
	.add_static(5, new WebSocketProvider({url: 'wss://goerli.infura.io/ws/v3/f36f6a8638134ac09f9400d3a7008dfe'}));

const DEFAULT_CHAIN = ensure_chain(1);
const ENS_CACHE = {};
const STORAGE_KEY = 'connected';

const input_field = document.querySelector('#input_field');
const output_div = document.querySelector('#output_div');
const primary_arrows = document.querySelector('#arrows');
const network_div = document.querySelector('#network');
const chain_select = document.querySelector('#network select');
const switch_default_btn = document.querySelector('#switch_default_btn');
const pair_btn = document.querySelector('#pair_btn');
const txs_div = document.querySelector('#txs');

let selected_chain = DEFAULT_CHAIN;
let last_resolve_chain;
let update_timer;
let dirty = false;
let waiting_for_window = true;
let window_provider;

determine_window_provider().then(p => {
	window_provider = p;
	providers.add_dynamic(p);
	p.on('connect', update_network);	
	p.on('chainChanged', update_network);
	// we might of missed the connect event
	// this is immediate if already connected
	// (doesn't require io)
	return p.request({method: 'eth_chainId'}).catch(() => {});
}).catch(() => {
	set_paired(false);
}).then(() => {
	waiting_for_window = false;
	update_network();
	mark_dirty();
});

// setup examples
for (let el of document.querySelectorAll('#examples button')) {
	el.addEventListener('click', () => {
		input_field.value = el.dataset.input ?? el.innerHTML;
		mark_dirty();
	});
}


window.addEventListener('hashchange', () => {
	apply_location_hash();
});


input_field.addEventListener('input', mark_dirty);
input_field.addEventListener('keydown', e => {
	if (e.key === 'Enter') {
		document.querySelector('#resolve_btn')?.click();
	}
});

for (let [chain, provider] of providers.available_providers()) {	
	chain_select.append(create_network_option(chain));
}
chain_select.addEventListener('change', () => {
	switch_network(chain_select.selectedOptions[0].dataset.chain);
});
switch_default_btn.innerHTML = `‚ôªÔ∏è Switch to ${DEFAULT_CHAIN.name}`;
switch_default_btn.addEventListener('click', () => {
	switch_network(DEFAULT_CHAIN);
});
pair_btn.addEventListener('click', () => {
	set_paired(!is_paired());
	update_network();
	mark_dirty();
});

apply_location_hash();

function apply_location_hash() {
	let s = decodeURIComponent(window.location.hash.slice(1));
	let pos = s.lastIndexOf('@');
	if (pos >= 0) {
		let chain = s.slice(pos + 1).trim();
		try {
			chain = ensure_chain(chain);
			if (current_chain() !== chain) {
				// forcing a wallet switch is stupid
				// so unpair then switch
				set_paired(false); 
				switch_network(chain);
				if (!waiting_for_window) {
					update_network();
				}
			}
			s = s.slice(0, pos);
		} catch (err) {
		}		
	}
	input_field.value = s;
	mark_dirty();
}
function set_paired(b) {
	if (b) {
		window.localStorage.setItem(STORAGE_KEY, '1');
	} else {
		window.localStorage.removeItem(STORAGE_KEY);
	}
}
function is_paired() {
	return window.localStorage.getItem(STORAGE_KEY);
}
function set_switching(b) {
	chain_select.disabled = b;
	switch_default_btn.disabled = b;
	network_div.querySelector('.switching').classList.toggle('hide', !b);
}
function switch_network(chain_like) {
	let chain = find_chain(chain_like);
	if (window_provider && is_paired()) {
		set_switching(true);
		window_provider.request({method: 'wallet_switchEthereumChain', params:[{chainId: chain.id}]}).catch(err => {
			update_network();
		});
	} else {
		selected_chain = chain;
		update_network();
	}
}
function current_chain() {
	if (!waiting_for_window && window_provider?.chain_id && is_paired()) {
		return ensure_chain(window_provider.chain_id);
	} else {
		return selected_chain;
	}
}
function update_network() {	
	set_switching(waiting_for_window);
	let chain = current_chain();
	chain_select.querySelector('.temporary')?.remove();
	let opt = chain_select.querySelector(`option[data-chain="${chain.id}"]`);
	if (!opt) {
		opt = create_network_option(chain);
		opt.classList.add('temporary');
		chain_select.append(opt);
	}
	chain_select.selectedIndex = [...chain_select.children].indexOf(opt);
	switch_default_btn.classList.toggle('hide', chain === DEFAULT_CHAIN);

	pair_btn.classList.toggle('hide', waiting_for_window || !window_provider);
	if (!waiting_for_window) {
		if (is_paired()) {
			pair_btn.innerHTML = '‚ùå Unpair from Browser';
		} else {
			pair_btn.innerHTML = 'üîó Pair with Browser';
		}
	}
		
	providers.find_provider(chain).then(p => {
		network_div.querySelector('#provider').innerHTML = p.source;
	}).catch(() => {});

	if (last_resolve_chain && last_resolve_chain !== chain) {
		mark_dirty();
	}
}
function create_network_option(chain) {
	let opt = document.createElement('option');
	opt.dataset.chain = chain.id;
	opt.innerHTML = chain.name;
	return opt;
}
function mark_dirty() {
	dirty = true;
	output_div.innerHTML = '';
	update();
}
function update() {
	if (!dirty || update_timer) return;
	primary_arrows.classList.remove('hide');	
	input_field.classList.remove(...input_field.classList);
	input_field.classList.add('working');
	if (waiting_for_window) return; // will get called later
	update_timer = setTimeout(resolve, 500);	
}
async function resolve() {
	clearTimeout(update_timer);
	dirty = false;
	output_div.innerHTML = '';

	let chain = last_resolve_chain = current_chain();
	let ens = ENS_CACHE[chain];
	if (!ens) {
		ens = ENS_CACHE[chain] = new ENS({
			provider: providers.view(chain), 
			ens_normalize
		});
	}

	let input = input_field.value.trim();
	window.history.replaceState('', null, input ? `#${input}@${chain.id}` : ' ');
	try {
		if (is_valid_address(input)) {
			input_field.classList.add('address');
			let owner = ens.owner(input);
			let reverse = await owner.get_primary_name();
			if (reverse) {
				let btn = document.createElement('button');
				btn.id = 'resolve_btn';
				btn.innerHTML = `Resolve: <b>${reverse}</b>`;
				btn.addEventListener('click', () => {
					input_field.value = reverse;
					mark_dirty();
				});
				output_div.append(btn);
			} else {
				output_div.innerHTML = `<div class="error">‚ùå <b>Primary Not Set</b></div>`; 
			}
		} else if (input) {
			let name = await ens.resolve(input);
			let display = await name.get_text('display').catch(() => false);
			let is_display = await name.is_input_display().catch(() => false);
			if (name.is_input_normalized()) {
				input_field.classList.add('norm');
			} else if (is_display) {
				input_field.classList.add('display');
			} else {
				input_field.classList.add('unnorm');
			}
			
			let a_ens = document.createElement('a');
			a_ens.innerHTML = 'View on ENS';
			a_ens.href = `https://app.ens.domains/name/${name.name}/details`;
			output_div.append(a_ens);

			if (!name.resolver) {
				output_div.innerHTML += `<div class="error">‚ö†Ô∏è <b>No resolver</b></div>`;
			} else {
				let address = await name.get_address().catch(() => 0);
				if (address) {
					let div = document.createElement('div');
					div.id = 'address';
					div.innerHTML = `<a class="address" href="${chain.explorer_address_uri(address)}">${address}</a>`;
					let copy_btn = document.createElement('button');
					copy_btn.innerHTML = 'Copy';
					copy_btn.addEventListener('click', () => navigator.clipboard.writeText(address));
					div.append(copy_btn);
					output_div.append(div);
				}

				if (is_display) {
					let span = document.createElement('span');
					span.innerHTML = `‚úÖ <b>Display Name</b>`;
					output_div.append(span);
				} else if (display) {
					let span = document.createElement('span');
					span.innerHTML = `<b>Display Name:</b> ${display}`;
					output_div.append(span);
				}


				if (window_provider) {
					let accounts = await window_provider.request({method: 'eth_accounts'}).catch(() => []);
					if (accounts.length > 0) {
						let owner = await name.get_owner_address();
						if (accounts[0].toLowerCase() !== owner.toLowerCase()) {
							let span = document.createElement('span');
							span.innerHTML = `‚ö†Ô∏è Not owned by you: <code>${short_address(accounts[0])}</code>`;
							output_div.append(span);
						} else if (!is_display) {
							let set_btn = document.createElement('button');
							set_btn.innerHTML = `‚úèÔ∏è Set Display: <b>${input}</b>`;
							set_btn.addEventListener('click', () => {
								let div = document.createElement('div');
								div.classList.add('tx');
								div.innerHTML = `<div class="working"><div class="arrows"></div></div><div class="info">Waiting for Signature</div>`;
								txs_div.append(div);
								// fix this: this is dogshit
								window_provider.request({
									method: 'wallet_switchEthereumChain', 
									params:[{chainId: chain.id}]
								}).then(() => window_provider.request({
									method: 'eth_sendTransaction',
									params: [{
										to: name.resolver.address,
										from: accounts[0],
										data: ABIEncoder.method('setText(bytes32,string,string)').number(name.node).string('display').string(input).build_hex()
									}]
								})).then(tx => {
									div.querySelector('.info').innerHTML = `${display} &rarr; <b>${input}</b>`;
									let a = document.createElement('a');
									a.href = chain.explorer_tx_uri(tx);
									a.classList.add('hash');
									a.target = '_blank';
									a.innerHTML = 'View Transaction';
									div.append(a);
									return window_provider.request({
										method: 'eth_subscribe',
										params: ['logs', {
											address: name.resolver.address,
											topics: ['0xd8c9334b1a9c2f9da342a0a2b32629c1a229b6445dad78947f674b44444a7550']
										}]
									}).then(sub => [tx, sub]);
								}).then(([tx, sub]) => new Promise((ful, rej) => {
									window_provider.on('message', ({type, data}) => {
										if (type !== 'eth_subscription') return;
										let {subscription, result} = data;
										if (subscription !== sub) return;
										if (result.removed) return;
										if (result.transactionHash !== tx) return;
										div.querySelector('.working').innerHTML = '‚úÖ <b>Success!</b>';
										if (input_field.value === input) {
											mark_dirty();
										}
										ful();
									});
								})).catch(err => {
									if (err.code == 4001) {
										div.remove();
										return;
									}
									div.innerHTML = `‚ùå ${err.message}`;
								});
							});
							output_div.append(set_btn);
						}
					} else {
						let connect_btn = document.createElement('button');
						connect_btn.innerHTML = '<b>Connect</b> to Set Display Name';
						connect_btn.addEventListener('click', () => {
							window_provider.request({method: 'eth_requestAccounts'}).then(() => {
								mark_dirty();
							}).catch(() => {});
						});	
						output_div.append(connect_btn);	
					}
				}
			}
		}
	} catch (err) {
		if (err.isInvalid) {
			input_field.classList.add('invalid');
			output_div.innerHTML = `<div class="error">‚ùå <b>${err.cause.message}</b></div>`;
		} else {
			output_div.innerHTML = `<div class="error">‚ùå <b>${err.message}</b></div>`;
		}		
	}
	input_field.classList.remove('working');
	primary_arrows.classList.add('hide');
	update_timer = false;
	if (dirty) update();
}
</script>
</body>
</html>