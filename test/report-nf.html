<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>NormalizationTest</title>
<style>
#version {
	padding-left: 1rem;
	font-size: 16pt;
	font-weight: normal;
}
table {
	width: 100%;
	border-collapse: collapse;
}
th {
	background: #ddd;
}
th[colspan] {
	font-size: 20pt;
}
td, th {
	border: 1px solid #ccc;
}
tbody tr:nth-child(odd) {
	background: #eee;
}
.same {
	background: #cfc;
}
.diff {
	background: #fcc;
}
#summary tbody td {
	text-align: right;
}
#loading {
	display: inline-block;
	margin-top: 1rem;
	background: #ffc;
	border-radius: 1rem;
	padding: 1rem 2rem;
	font-size: 24pt;
	border: 1px solid #ccc;
}
</style>
</head>
<body>
<h1><a href="../build/unicode-raw/NormalizationTest.txt">NormalizationTest</a></h1>
<table id="summary"><thead>
<tr><th rowspan="2">Test</th><th rowspan="2">Cases</th><th colspan="2">adraffy</th><th colspan="2">Browser</th></tr>
<tr><th>NFD</th><th>NFC</th><th>NFD</th><th>NFC</th></tr>
</thead><tbody></tbody></table>
<div id="loading">Computing..</div>
<script type="module">
import {nfc_adraffy, nfd_adraffy, nfc_default, nfd_default} from '../dist/nf.min.js';

//document.querySelector('#version').innerHTML = ` v${VERSION} for Unicode ${UNICODE}`;

try {
	main();
} catch (err) {
	let div = document.createElement('div');
	div.innerHTML = err.message;
	document.body.append(div);
	console.error(err);
}

function escape_unicode(cps) {
	return cps.map(cp => {
		let s = String.fromCodePoint(cp);
		return /[\.\-a-z0-9]/.test(s) ? s : `{${cp.toString(16).toUpperCase()}}`;
	}).join('');
}
function cps_from_sequence(s) {
	return s.split(/\s+/).map(x => parseInt(x, 16));
}

function compare_array(a, b) {
	let {length: n} = a;
	let c = n - b.length;
	for (let i = 0; c == 0 && i < n; i++) c = a[i] - b[i];
	return c;
}

async function main() {	
	let res = await fetch('../build/unicode-json/NormalizationTest.json');
	if (res.status !== 200) throw new Error('download error');
	let tests = await res.json();
	tests = Object.entries(tests).sort((a, b) => b[1].length - a[1].length);
	next();
	function next() {
		if (tests.length == 0) {
			document.querySelector('#loading').remove();
			return;
		}
		let [name, cases] = tests.pop();
		let html = `<a name="${name}"></a><h2>${name}(${cases.length})</h2><table><thead>
		<tr><th rowspan="2">Input</th><th colspan="3">NFD</th><th colspan="3">NFC</th></tr>
		<tr><th>Expected</th><th>adraffy</th><th>Browser</th><th>Expected</th><th>adraffy</th><th>Browser</th></tr>
		</tr></thead><tbody>`;
		let errors = {};
		function compare_cell(v0, v1, key) {
			if (v0.length == v1.length && v0.every((x, i) => x == v1[i])) {
				return '<td class="same"></td>';
			} else {
				errors[key] = (errors[key] ?? 0) + 1;
				return `<td class="diff">${escape_unicode(v1)}</td>`;
			}
		}
		for (let args of cases) {
			let [src, nfc0, nfd0] = args.map(cps_from_sequence);
			html += '<tr>' + [
				`<td class="input">${escape_unicode(src)}</td>`,
				`<td class="expect">${escape_unicode(nfd0)}</td>`,
				compare_cell(nfd0, nfd_adraffy(src), 'nfc_adraffy'),
				compare_cell(nfd0, nfd_default(src), 'nfd_default'),
				`<td class="expect">${escape_unicode(nfc0)}</td>`,
				compare_cell(nfc0, nfc_adraffy(src), 'nfd_adraffy'),
				compare_cell(nfc0, nfc_default(src), 'nfc_default')
			].join('') + '</tr>';
		}
		html += '</body></table>';

		let section = document.createElement('section');
		section.innerHTML = html;
		document.body.append(section);


		function total_cell(key) {
			let total = errors[key];
			if (total > 0) {
				return `<td class="diff">${total}</td>`;
			} else {
				return `<td class="same">0</td>`;
			}
		}

		let tr = document.createElement('tr');
		tr.innerHTML = [
			`<td class="name"><a href="#${name}">${name}</a></td>`,
			`<td class="count">${cases.length}</td>`,
			total_cell('nfd_adraffy'),
			total_cell('nfc_adraffy'),
			total_cell('nfd_default'),
			total_cell('nfc_default')
		].join('');

		document.querySelector('#summary tbody').append(tr);
		setTimeout(next, 0);
	}
}
</script>
</body>
</html>