<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Confusables by Script</title>
<style>
body {
	margin: 1rem;
}
#version {
	position: absolute;
	right: 1rem;
	top: 1rem;
	text-align: right;
}
#loading {
	display: inline-block;
	margin-top: 1rem;
	background: #ffc;
	border-radius: 1rem;
	padding: 1rem 2rem;
	font-size: 24pt;
	border: 1px solid #ccc;
}
table {
	border-collapse: collapse;
	width: 100%;
}
td { 
	border: 1px solid #aaa; 
	text-align: center;
}
tbody tr:nth-child(odd) {
	background: #eee; 
}
.form {
	font-size: 20pt;
	font-weight: bold;
}
.groups > div {
	padding: 5px;
	display: flex;
	flex-wrap: wrap;
	gap: 5px;
}
.bucket {
	display: flex;
	gap: 2px;
	padding: 2px;
	align-items: center;
	background: #ccc;
	border: 1px solid #aaa;
}
.bucket.multi {
	background: #fcc;
}

</style>
</head>
<body>
<h1><a href="../build/unicode-raw/confusables.txt">Confusables by Script</a></h1>
<div id="version"><a href="https://github.com/adraffy/ens-normalize.js">@adraffy/ens-normalize</a></div>
<div id="loading">Computing...</div>	
<script type="module">
import {escape_name_for_html, compare_arrays, hex_cp, explode_cp, parse_cp, parse_cp_range, parse_cp_sequence} from '../build/utils.js';
import {ens_normalize, ens_tokenize, VERSION, IDNA, UNICODE, BUILT} from '../dist/ens-normalize-2008.min.js';
import {dom_from_tokens, use_default_style} from '../dist/parts.min.js';
use_default_style();

document.querySelector('#version').innerHTML += ` (v${VERSION}+${IDNA}+U${UNICODE})<br><code>${BUILT}</code>`;

try {
	await main();
} catch (err) {
	let div = document.createElement('div');
	div.innerHTML = err.message;
	document.body.append(div);
	console.error(err);
}

function key_from_tokens(tokens) { 
	return String.fromCodePoint(...tokens.flatMap(t => t.e ?? t.v ?? t.m ?? t.i ?? t.d ?? []));
	//return JSON.stringify(t, (k, v) => k === 'u' ? undefined : v); 
}

async function main() {
	
	let [confusables, names, scripts] = await Promise.all([
		'../build/unicode-json/confusables.json', // target -> [src, src2, ...]
		'../build/unicode-json/Names.json', // dec -> str
		'../build/unicode-json/Scripts.json' // name -> [cps seq, ...]
	].map(url => fetch(url).then(res => {
		if (res.status !== 200) throw new Error(`Download failed: HTTP Code ${res.status}`);
		return res.json();
	})));

	confusables = Object.entries(confusables).map(([k, v]) => [k, ...v].map(parse_cp_sequence));

	scripts = Object.fromEntries(Object.entries(scripts).map(([k, v]) => [k, new Set(v.flatMap(parse_cp_range))]));
	let common_set = new Set();
	for (let key of ['Common', 'Inherited']) {
		scripts[key]?.forEach(cp => common_set.add(cp));
		delete scripts[key];
	}
	scripts = Object.entries(scripts);
	scripts.unshift(['Common', common_set]);

	function script_from_cp(cp) {
		for (let [k, v] of scripts) {
			if (v.has(cp)) {
				return k;
			}
		}
		return 'Unknown';
	}


	

	for (let [script_name, script_set] of scripts) {
		let found = [];

		for (let matches0 of confusables) {
			// find the confusables that are of the same initial set
			let matches = matches0.filter(cps => cps.every(cp => common_set.has(cp) || script_set.has(cp)));
			if (matches.length < 2) continue;
			if (!matches.some(cps => cps.some(cp => script_set.has(cp)))) continue;

			let buckets = {};
			for (let cps of matches) {
				let tokens = ens_tokenize(String.fromCodePoint(...cps));
				if (tokens.some(t => t.d)) continue;
				let key = String.fromCodePoint(...tokens.flatMap(t => t.e ?? t.v ?? t.m ?? []));
				let bucket = buckets[key];
				if (!bucket) buckets[key] = bucket = [];
				bucket.push(tokens);
			}
			buckets = Object.values(buckets);
			if (buckets.length < 2) continue;
			found.push([matches0[0], buckets.sort((a, b) => b.length - a.length)]);
		}
		if (found.length == 0) continue;

					
		let section = document.createElement('section');
		section.innerHTML = `<h2>${script_name}</h2><table><thead><tr><th>Confusable</th><th>#</th><th>Normalized Groups</th></tr></thead><tbody></tbody></table>`;
		section.querySelector('tbody').append(...found.map(([confusable, buckets]) => {
			let tr = document.createElement('tr');
			tr.innerHTML = `<td class="form">${String.fromCodePoint(...confusable)}</td><td>${buckets.length}</td><td class="groups"><div></div></td>`;
			let container = tr.querySelector('.groups div');
			for (let bucket of buckets) {
				let div = document.createElement('div');
				div.classList.add('bucket');
				div.append(dom_from_tokens(bucket[0], true));

				let set = new Set(bucket[0].flatMap(t => t.e ?? t.v ?? t.m ?? []).map(script_from_cp));
				set.delete(script_name);
				set.delete('Common');
				set.delete('Unknown');
				if (set.size > 0) {
					div.classList.add('multi');
				}

				let span = document.createElement('span');
				span.innerHTML = '←';
				div.append(span);
				div.append(...bucket.map(tokens => dom_from_tokens(tokens, false)));
				for (let el of div.querySelectorAll('*[title]')) {
					let cp = el.innerHTML.codePointAt(0);
					el.title = `${names[cp]}\n${script_from_cp(cp)}\n${el.title}`;
				}
				container.append(div);
			}
			return tr;
		}));
		document.body.append(section);
	}

	//document.querySelector('h1').innerHTML += ` (${group_count} groups)`;
		
	document.querySelector('#loading').remove();
}
</script>
</body>
</html>