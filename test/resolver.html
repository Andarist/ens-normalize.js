<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ENS Resolver</title>
<style>
.hide {
	display: none !important;
}
a, button {
	cursor: pointer;
}
body { 
	margin: 3rem; 
	background: #eee;
	display: flex;
	flex-direction: column;
	gap: 0.7rem;
	overflow-y: scroll;
}
header {
	display: flex;
	justify-content: space-between;
}
h1 {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	margin: 0;
	gap: 0.2rem;
}
h1 a {
	font-size: 24pt;
	white-space: pre;
}
#provider {
	font-size: 11pt;
	font-weight: normal;
	color: #666;
}
#version {
	text-align: right;
	box-sizing: border-box;
	width: min-content;
}
#version a {	
	white-space: pre;
}
.arrows {
	width: 2rem;
	padding-bottom: 100%;
	animation: spin 2s infinite linear;
	user-select: none;
	background-image: url('data:image/svg+xml;utf8,%3Csvg%20viewBox%3D%220%200%201000%201000%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M990%2C377.5H622.5l137.4-137.4C690.4%2C170.7%2C598.2%2C132.5%2C500%2C132.5c-98.2%2C0-190.4%2C38.2-259.9%2C107.6C170.7%2C309.6%2C132.5%2C401.8%2C132.5%2C500c0%2C98.2%2C38.2%2C190.4%2C107.6%2C259.9c69.4%2C69.4%2C161.7%2C107.6%2C259.9%2C107.6c98.2%2C0%2C190.4-38.2%2C259.9-107.6c5.8-5.8%2C11.4-11.8%2C16.7-17.9l92.2%2C80.7C778.9%2C925.2%2C647%2C990%2C500%2C990C229.4%2C990%2C10%2C770.6%2C10%2C500C10%2C229.4%2C229.4%2C10%2C500%2C10c135.3%2C0%2C257.8%2C54.9%2C346.5%2C143.5L990%2C10V377.5z%22%2F%3E%3C%2Fsvg%3E');
	background-size: contain;
	background-repeat: no-repeat;
}
@keyframes spin {
	from { transform:rotate(0deg); }
	to { transform:rotate(360deg); }
}
#examples {
	display: flex;
	flex-wrap: wrap;
	align-items: center;
	gap: 3px;
}
#input label {
	display: none;
}
#input input {
	box-sizing: border-box;
	width: 100%;
	padding: 0.5rem;
	font-size: 16pt;
}
#controls {
	display: flex;
	flex-wrap: wrap;
	justify-content: flex-end;
	align-items: center;
	gap: 0.5rem;
}
#controls button {
	align-self: stretch;
	padding: 0.2rem;
}
input[type=checkbox], label {
	user-select: none;
	cursor: pointer;
}
input[type=checkbox]:checked + label.nonstd {
	background: #f00;
	color: #fff;
	outline: 2px solid #f00;
	border-radius: 5px;
}
#controls .balloon {
	flex-grow: 1;
}
#resolve_btn {
	font-size: 16pt;
	font-weight: bold;
}
#output {
	display: flex;
	flex-direction: column;
	gap: 0.7rem;
	font-size: 14pt;
}
.row-label {
	text-align: right;
	font-weight: bold;
	white-space: pre-wrap;
}
.row .arrows {
	width: 1.5rem;
}
.row {
	padding: 0.7rem;
	background: #fff;
	display: flex;
	align-items: center;
	gap: 0.5rem;
}
.row.display {
	background: #eff;
}
.row.normalized {
	background: #efe;
}
.row.skipped {
	background: linear-gradient(90deg, #efe, #fcc);
}
.row.addr {
	background: #ffd;
}
.row.dns {
	background:#f5faff; 
}
.row.dns.invalid2 {
	background: #fcc;
}
.row.dns.invalid {
	background: #fff0f0;	
	border: 3px dashed #fcc;
}
.row.pretty {
	background: linear-gradient(90deg, #fff, #fff0fc);
}
.row.ethmoji {
	background: linear-gradient(90deg,#fff,#efe);
}
.row .main {
	font-size: 16pt;
	padding-top: 4px;
	padding-bottom: 2px;
	border-bottom: 2px solid #000;
}
ul.row {
	flex-direction: column;
	align-items: start;
	margin: 0;
	padding-left: 2rem;
	background: #ffc;
}
.hash {
	line-break: anywhere;
}
.exploded {
	display: flex;
	flex-wrap: wrap;
	gap: 0.5rem;
}
.tags sub {
	padding-left: 0.1rem;
}
.tags {
	display: flex;
	flex-wrap: wrap;
	gap: 0.5rem;
	align-items: center;
}
.tags button {
	align-self: stretch;
}
.tags span {
	background: #ddd;
	color: #555;
	padding: 0.2rem 0.5rem;
	font-size: 12pt;
	border-radius: 0.5rem;
	border: 1px solid #ccc;
	white-space: pre;
}
.tags .long {
	white-space: normal;
	line-break: anywhere;
}
.tags .opensea {
	order: 8;
}
.tags .metadata {
	order: 9;
}
.tags .ens {
	order: 10;
}
.tags .elapsed {
	background: #cff;
	font-size: 80%;
	order: 20;
}
.tags .length {
	order: -10;
	background: #fff;
}
.tags .bytes {
	order: -10;
	background: #f8eedd;
}
.tags .okay {
	background: #ffc;
}
.tags .good {
	color: #060;
	background: #cfc;
}
.tags .best {
	color: #060;
	background: #cfc;
	font-weight: bold;
	border-color: #060;
}
.tags .warn {
	background: #ffc;
}
.tags .fail {
	background: #fcc;
	color: #600;
}
.tags .wildcard {
	background: #f84;
	border: none;
	color: #fff;
}
.tags .pretty {
	background: #f8e8f0;
	border-color: #f9e;
	color: #c900a2;
}
.row.hashes {
	display: grid;
	background: none;
	padding: 0 0.5rem;
	grid-template-columns: 20% min-content 30% auto;
	align-items: start;
	gap: 0.5rem;
	font-size: 12pt;
	box-sizing: border-box;
	width: 100%;
}
.hashes .length {
	text-align: center;
	color: #777;
}
.hashes .text {
	line-break: anywhere;
	text-align: right;
}
.hashes .cp {
	white-space: break-spaces;
}
.hashes .name {
	grid-column: 1 / -1;
	text-align: center;
} 
.tokens {
	font-size: 16pt;
}
.row.error {
	background: #fcc;
	border: 3px dashed #f00;
}
.transform {
	background: #fffaf0;
}
footer {
	text-align: center;
	color: #666;
	margin-top: 1rem;
	margin-bottom: 0.5rem;
}
@media only screen and (max-width: 800px) { 
	body {
		margin: 0;
	}
	button {
		font-size: 100%;
	}
	header {
		margin: 1rem 1rem 0 1rem;
	}
	#input, #controls, #options, #examples {
		margin: 0 1rem;
	}
	.error {
		border-left: 0;
		border-right: 0;
	}
	#examples_btn {
		display: block;
		font-size: 150%;
	}
}
</style>
</head>
<body>
<header>
<h1><a href="https://ens.domains/">ENS Resolver</a><span id="provider"></span></h1>
<span id="version"><a href="https://github.com/adraffy/ens-normalize.js">@adraffy/ens-normalize.js</a><br>
<a href="https://github.com/adraffy/ensip-norm">@adraffy/ensip-norm</a></span>
</header>
<div id="examples">
<button>vitalik.eth</button>
<button>bRAnTlY.eTh</button>
<button>brantly.cash</button>
<button data-name=".eth">❌.eth</button>
<button>öbb</button>
<button>Öbb</button>
<button data-name="◌̈bb">❌◌̈bb</button>

<a href="https://adraffy.github.io/punycode.js/test/demo.html"><b>Punycode:</b></a>
<button>❌xn--ls8h</button>
<button>xn--💩</button>
<button>💷pound.eth</button>

<b>Subdomain:</b>
<button data-name="nowzad.loopring.eth">loopring</button>
<button data-name="239.chonksociety.eth">Chonk #239</button>
<button>raffy.antistupid.com</button>
<button>barmstrong.cb.id</button>

<!--
<a href="./display.html"><b>Display:</b></a>
<button>ADRaffy</button>
-->

<b>Address:</b>
<button data-name="0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045">d8dA..6045</button>

<b>Hyperlink:</b>
<button data-name="https://opensea.io/assets/ethereum/0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85/91842011529764390124322931916134555051359118325819011691525342013207339157209">OpenSea</button>

<b>Mapped:</b> 
<button>™️</button>
<button>🈂️</button>
<button>Ⅷ</button>
<button data-name="hyph{2D}{2010}{2011}{2012}{2013}{2014}{2015}{2027}{2043}{207B}{208B}{2212}{23AF}{23BA}{23BB}{23BC}{23BD}{23E4}{FE31}{FE32}{FE58}ens">Hyphens</button>

<b>Ignored:</b> 
<button data-name="{FE0E}{FE0F}">Emoji Style</button>

<b>Disallowed:</b>
<button>te[st</button>

<b>Deviation:</b> 
<button>ß</button>
<button>ς</button>

<b>Complex:</b>
<button data-name="_E{FE0E}{303}{AD}{1F21A}{FE0F}a"></button>

<b>Combining Marks:</b>
<button data-name="{330}">Leading</button>
<button data-name="x{305}{330}">Adjacent</button>
<button data-name="💩{330}">Emoji</button>
<button data-name="-{330}">Isolated</button>
<button data-name="ǖ">Decomposed</button>

<b>Whitespace:</b>
<button data-name="te st">Inner</button>
<button data-name=" test">Leading</button>
<button data-name="test ">Trailing</button>

<b>Stops:</b>
<button>。</button>
<button>．</button>
<button>｡</button>
<button>۔</button>

<a href="https://unicode.org/reports/tr46/#Validity_Criteria"><b>CheckHyphen:</b></a>
<button>-test</button>
<button>test-</button>
<button>❌te--st</button>

<b>Underscore:</b>
<button>__ab</button>
<button>❌a_b</button>

<b>Goofy:</b>
<button data-name="[ba967c160905ade030f84952644a963994eeaed3881a6b8a4e9c8cbe452ad7a2].eth" data-skip="1">"💩.eth"</button>

<a href="./emoji.html"><b>Emoji:</b></a>
<button id="random_emoji_btn">🎲 Random</button>
<button>©</button>
<button>🛥</button>
<button>🚀🚀🚀</button>
<button>💩💩💩</button>
<button>🚴‍♀️🚴‍♂️🚴🚴🏻🚴🏼🚴🏽🚴🏾🚴🏿</button>
<button>👁️‍🗨️</button>
<button>🧟‍♂</button>
<button>🧟♂</button>
<button>😵‍💫😵‍💫😵‍💫</button>
<button>😵💫😵💫😵💫</button>
<button>👩🏽‍⚕️</button>
<button>👨‍👩‍👦</button>
<button>🤼🏻‍♂️</button>
<button>🤼🏻‍♀️</button>

<button data-name="💩{200D}💩">❌💩+💩</button>
<button data-name="{1F469}{1F3FE}{200D}{1F91D}{200D}{1F469}{1F3FE}">❌Mod+Mod</button>

<b>Regional:</b>
<button>❌🇦</button>
<button>❌🇦🇦</button>
<button>🇺🇸🇺🇲</button>

<b>Flag:</b>
<button>🏴</button>
<button>🏁️</button>
<button>🏳️‍🌈</button>

<b>Tag:</b>
<button data-name="{1F3F4}{E0067}{E0062}{E0065}{E006E}{E0067}{E007F}" data-replace></button>
<button data-name="{1F3F4}{E0067}{E0062}{E0073}{E0063}{E0074}{E007F}" data-replace></button>
<button data-name="{1F3F4}{E0067}{E0062}{E0077}{E006C}{E0073}{E007F}" data-replace></button>
<button data-name="{1F3F4}{E0075}{E0073}{E0063}{E0061}{E007F}">❌usca</button>

<b>Circled/Squared:</b>
<button>mmm</button>
<button>ⓂⓂⓂ</button>
<button>Ⓜ️Ⓜ️Ⓜ️</button>
<button>🅜🅜🅜</button>
<button>🅼🅼🅼</button>
<button>❻❻❻</button>
<button>➏➏➏</button>

<a href="https://datatracker.ietf.org/doc/html/rfc5892#appendix-A.1"><b>ContextJ:</b></a>
ZWNJ:
<button data-name="ന്{200C}മ"></button>
<button data-name="نیم‌فاصله"></button>
<button data-name="a{200C}b"></button>

ZWJ:
<button data-name="ണ്‍"></button>
<button data-name="a{200D}b"></button>

<a href="https://datatracker.ietf.org/doc/html/rfc5892#appendix-A.3"><b>ContextO:</b></a>
Middle Dot: 
<button data-name="{6C}{B7}{6C}"></button>
<button data-name="a{B7}b">❌</button>
• 
Greek Keraia: 
<button data-name="{375}{0377}"></button>
• 
Hebrew Geresh 
<button data-name="{05D1}{5F3}"></button>
• 
Katakana:
<button data-name="{30A1}{30FB}"></button>
<button data-name="ab{30FB}"></button>

<a href="https://www.rfc-editor.org/rfc/rfc5893.html#section-2"><b>CheckBidi:</b></a>
<button>פעילותהבינאום</button>
<button data-name="{0786}{07AE}{0782}{07B0}{0795}{07A9}{0793}{07A6}{0783}{07AA}">Dhivehi</button>
<button data-name="{05D9}{05B4}{05D5}{05D0}{05B8}">Yiddish</button>
<button data-name="{1F1F8}{1F1E6}{633}{644}{645}{627}{646}">Emoji+RTL</button>
<button data-name="{633}{644}{645}{627}{646}{1F1F8}{1F1E6}">RTL+Emoji</button>
<button data-name="bahrain.مصر">Separate LTR and RTL Labels</button>
<button data-name="bahrainمصر">Mixed LTR+RTL in Label</button>
<button data-name="{202e}elgoog{202d}.eth">❌.ethgoogle</button>
<button data-name="{202e}hte.elgoog">❌google.eth</button>

<b>Mapped Emoji:</b>
<button>‼️</button>
<button>⁉️</button>

<b>Keycaps:</b>
<button>6️⃣9️⃣</button>
<button>1⃣2️⃣🔟.eth</button>
<button>*️⃣</button>
<button>#️⃣</button>

<b>Currency:</b>
<button>$¢£¤¥€₿Ξ</button>

<a href="https://util.unicode.org/UnicodeJsps/confusables.jsp">Confusables</a>/
<a href="https://unicode-org.github.io/cldr-staging/charts/latest/by_type/core_data.alphabetic_information.main.html">Exemplars</a>
<b>Single Script:</b>
<button>aɑ</button>

<b>Mixed-Script:</b>
<button data-name="1a〆">Digit+Latin+Han</button>
<button>дре</button>
<button>❌aрe</button>
<button>❌ѐè</button>

<b>Whole-Script:</b>
<button>дррӏе</button>
<button>❌аррӏе</button>
<button>❌ρον</button>

<b>Arabic-Indic:</b>
<button data-name="{661}{662}{663}"></button>
<button data-name="{6F1}{6F2}{6F3}"></button>
<button data-name="{661}{662}{664}"></button>
<button data-name="{6F1}{6F2}{664}"></button>

<a href="https://unicode.org/emoji/charts/emoji-released.html"><b>Unicode 15:</b></a>
<button data-name="{1F6DC}{1FA75}{1FA76}{1FA77}{1FA87}{1FA88}{1FAAD}{1FAAE}{1FAAF}{1FABB}{1FABC}{1FABD}{1FABF}{1FACE}{1FACF}{1FADA}{1FADB}{1FAE8}{1FAF7}{1FAF8}">Single Emoji (20)</button>
<button data-name="{1FAF7}{1F3FB}{1FAF7}{1F3FC}{1FAF7}{1F3FD}{1FAF7}{1F3FE}{1FAF7}{1F3FF}{1FAF8}{1F3FB}{1FAF8}{1F3FC}{1FAF8}{1F3FD}{1FAF8}{1F3FE}{1FAF8}{1F3FF}">Sequences (10)</button>
<button data-name="{1F426}{200D}{2B1B}">Black Bird</button>

<b>Apostrophe:</b>
<button>a'</button>
<button>’z</button>
<button>a'’b</button>
<button>O'Brian</button>

<b>Fraction Slash:</b>
<button>½</button>
<button>000⁄000</button>

<b>Misc:</b>
<button>•-•¬</button>
<button>360°</button>

<a href="https://www.unicode.org/reports/tr31/#Table_Candidate_Characters_for_Exclusion_from_Identifiers"><b>Excluded:</b></a>
<button data-name="𓀀𓀁𓀂">Egyptian Hieroglyphs</button>
<button>𓆏➡🐸️</button>
<button data-name="𐌱𐌻𐍉𐌼𐌰">Gothic</button>
<button data-name="a𓀂">❌Mixed</button>

</div>
<div id="options">
<label><input type="checkbox" id="auto_resolve_check" checked>Resolve on Input</label>
<label><input type="checkbox" id="show_hashes_check" checked>Show Details</label>
<span><input type="checkbox" id="skip_norm_check"><label class="nonstd" for="skip_norm_check">Skip Normalization</label></span>
</div>
<div id="input">
<label for="input_field">Name or Address:</label>
<input id="input_field" size="20" placeholder="Name or Address (Checksummed) or OpenSea URL">
</div>
<div id="controls">
<div id="arrows" class="hide"><div class="arrows"></div></div>
<div class="balloon"></div>
<button id="nf_btn">NFD↔NFC</button>
<button id="escape_btn">Escape</button>
<button id="link_btn">Copy Link</button>
<button id="resolve_btn">Resolve</button>
</div>
<div id="output">
<ul class="row">
<li>Click an <button data-name="bRANtly.eth">Example</button> to see how it works.</li>
<li>Use <code>{FF}</code> or <code>[255]</code> to manually include codepoints, eg. <button data-escape data-name="a{200D}b.eth">ZWJ</button></li>
<li>Input <code>"0123 4567 89AB CDEF"</code> to interpret as hex codepoints.</li>
<li><b>Copy Link</b> to get a URL that resolves on page-load.</li>
</ul>
</div>
<footer>Created by <a href="https://twitter.com/adraffy">raffy.eth</a></footer>
<script type="module">
import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.1/ethers.esm.min.js";
import {
	ens_normalize, ens_beautify, ens_tokenize, ens_emoji, nfc, nfd, dns_from_normalized_ens,
	escape_for_html, is_printable_ascii, hex_cp, explode_cp,
	dom_from_tokens, use_default_style
} from '../dist/all.min.js';
use_default_style();

let infura_provider = new ethers.providers.WebSocketProvider('wss://mainnet.infura.io/ws/v3/f36f6a8638134ac09f9400d3a7008dfe');
let active_provider = infura_provider;
let window_provider;
let registry_contract;
let eth_nft_contract;

const EMOJI = ens_emoji();

const input_field = document.querySelector('#input_field');
const resolve_btn = document.querySelector('#resolve_btn');
const primary_arrows = document.querySelector('#arrows');
const auto_resolve_check = document.querySelector('#auto_resolve_check');
const skip_norm_check = document.querySelector('#skip_norm_check');
const show_hashes_check = document.querySelector('#show_hashes_check');
const options_div = document.querySelector('#options');
const controls_div = document.querySelector('#controls');
const output_div = document.querySelector('#output');
const readme_rows = [...output_div.childNodes]; // save initial ux
const examples_div = document.querySelector('#examples');
const examples_btn = document.createElement('button');
examples_btn.id = 'examples_btn';

const RESOLVE_MODE_IDLE = 'idle';
const RESOLVE_MODE_REPEAT = 'repeat';
const RESOLVE_MODE_EMPTY = 'empty';

const SKIP_SUFFIX = '_!';

let resolve_timer = RESOLVE_MODE_IDLE;
let resolve_options;
let resolve_date0;

examples_div.classList.toggle('hide', !!window.localStorage.getItem('hide_examples'));
show_hashes_check.selected = !!window.localStorage.getItem('show_hashes');
auto_resolve_check.selected = !!window.localStorage.getItem('auto_resolve');

for (let btn of document.querySelectorAll('#examples button:not([id]), button[data-name]')) {
	let name = btn.innerHTML;
	if (btn.dataset.name) {
		name = btn.dataset.name;
	} else if (name.startsWith('❌')) {
		name = [...name].slice(1).join('');
	}
	name = replace_escapes(name);
	if (typeof btn.dataset.replace === 'string' || !btn.innerHTML) btn.innerHTML = name;
	if (!name.includes('.') && !is_checksum_address(name)) name += '.eth';
	if (typeof btn.dataset.escape === 'string') name = apply_escapes(name, false);
	if (!btn.title) btn.title = `${name}\n${explode_cp(name).map(hex_cp).join(' ')}`;
	btn.addEventListener('click', () => {
		input_field.value = name;
		skip_norm_check.checked = btn.dataset.skip;
		if (options_div.getBoundingClientRect().top > window.innerHeight * .9) {
			options_div.scrollIntoView(); // scuffed
		}
		resolve();
	});
}

resolve_btn.addEventListener('click', () => resolve());
input_field.addEventListener('keydown', e => {
	if (e.key === 'Enter') {
		e.stopPropagation();
		resolve();
	}
});
input_field.addEventListener('input', () => {
	if (parse()) {
		schedule_resolve(1000);
	}
});

document.querySelector('#random_emoji_btn').addEventListener('click', () => {
	let name = '';
	while ([...name].length < 3) {
		name += ens_normalize(String.fromCodePoint(...EMOJI[Math.random() * EMOJI.length|0]));
	}
	input_field.value = `${name}.eth`;
	skip_norm_check.checked = false;
	resolve();
});

document.querySelector('#nf_btn').addEventListener('click', () => {
	let s0 = input_field.value;
	let s1 = replace_escapes(s0);
	let s3 = apply_escapes(String.fromCodePoint(...nfd(explode_cp(s1))));
	let s4 = apply_escapes(String.fromCodePoint(...nfc(explode_cp(s1))));
	let s5 = s0 == s3 ? s4 : s3;
	if (s0 != s5) {
		input_field.value = s5;
		resolve();
	}
});

document.querySelector('#escape_btn').addEventListener('click', () => {
	let s0 = input_field.value;
	let s1 = replace_escapes(s0);
	let s2 = apply_escapes(s1);
	let s3 = apply_escapes(s1, true);
	let set = [...new Set([s1, s2, s3])];
	let pos = set.indexOf(s0);	
	input_field.value = set[(pos + 1) % set.length];
});

document.querySelector('#link_btn').addEventListener('click', () => {
	let hash = '#' + encodeURIComponent(input_field.value);
	if (skip_norm_check.checked) hash += SKIP_SUFFIX;
	navigator.clipboard.writeText(window.location.href.split('#')[0] + hash);
});

auto_resolve_check.addEventListener('input', () => {
	window.localStorage.setItem('auto_resolve', auto_resolve_check.checked ? '1' : '');	
	if (auto_resolve_check.checked && input_field.value) {
		if (parse()) resolve();
	}
});
show_hashes_check.addEventListener('input', () => {	
	window.localStorage.setItem('show_hashes', show_hashes_check.checked ? '1' : '');
	for (let el of document.querySelectorAll('.hashes')) {
		el.classList.toggle('hide', !show_hashes_check.checked);
	}
});
skip_norm_check.addEventListener('input', () => {
	if (auto_resolve_check.checked && input_field.value) {
		resolve();
	}
});
examples_btn.addEventListener('click', () => {
	examples_div.classList.toggle('hide');
	window.localStorage.setItem('hide_examples', examples_div.classList.contains('hide') ? '1' : '');
	update_examples();
});

if (window.ethereum) {
	window_provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
	window_provider.on('network', update_network);
} else {
	update_network();
}

update_examples();
input_field.focus();
apply_location_hash();
window.addEventListener('hashchange', apply_location_hash);

function update_network(network) {
	let registry;
	let name;
	if (network && network.ensAddress) {
		active_provider = window_provider;
		name = `window.ethereum (${network.name.replace('homestead', 'mainnet')})`;
		registry = network.ensAddress;
	} else {
		active_provider = infura_provider;
		name = `Infura (mainnet)`;
		registry = '0x00000000000C2E074eC69A0dFb2997BA6C7d2e1e';
	}
	document.querySelector('#provider').innerHTML = `using ${name}`;
	registry_contract = new ethers.Contract(registry, [
		`function resolver(bytes32 node) external view returns (address)`,
		`function owner(bytes32 node) external view returns (address)`,
	], active_provider);
	eth_nft_contract = null;

	if (input_field.value) {
		schedule_resolve(250);
	}
}

function update_examples() {
	if (examples_div.classList.contains('hide')) {
		examples_btn.innerHTML = '👀 Show Examples';
		options_div.prepend(examples_btn);
	} else {
		examples_btn.innerHTML = '🙈 <b>Hide Examples</b>';
		examples_div.prepend(examples_btn);
	}
}

function apply_location_hash() {
	let name = decodeURIComponent(window.location.hash.slice(1));
	let skip = name.endsWith(SKIP_SUFFIX);
	if (skip) name = name.slice(0, -SKIP_SUFFIX.length);
	skip_norm_check.checked = skip;
	input_field.value = name;
	resolve();
}

function should_stop_resolving() {
	return resolve_timer !== RESOLVE_MODE_IDLE;
}

function schedule_resolve(delay) {
	if (!auto_resolve_check.checked) return;
	resolve_options = {
		automatic: true,
		skip_norm: skip_norm_check.checked
	};
	if (is_working()) {
		resolve_timer = RESOLVE_MODE_REPEAT;
	} else if (!should_stop_resolving()) {
		primary_arrows.classList.remove('hide');
		resolve_timer = setTimeout(() => resolve(resolve_options), delay);
	}
} 

function stop_resolving() {
	clearTimeout(resolve_timer);
	resolve_timer = RESOLVE_MODE_EMPTY;
	primary_arrows.classList.add('hide');
}

function parse() {
	output_div.innerHTML = '';
	let name = replace_escapes(input_field.value);
	controls_div.classList.toggle('hide', !name);
	if (!name) {
		stop_resolving();
		output_div.append(...readme_rows);
		return;
	}
	if (resolve_timer === RESOLVE_MODE_EMPTY) {
		resolve_timer = RESOLVE_MODE_IDLE;
	}
	if (is_checksum_address(name)) {
		let row = create_row('Address');
		row.append(create_etherscan_address_link(name));
		output_div.append(row);
		return true;
	}
	let row = create_row('Name');
	make_exploded(row, name, false);
	add_row_tag(row, create_class_tag(name));
	output_div.append(row, create_hashes_row(name));
	if (skip_norm_check.checked) return true;
	try {
		let norm = ens_normalize(name);
		if (norm === name) {
			row.classList.add('normalized');
		} else {
			add_transformed_row(name);
			let norm_row = create_row('Normalized');
			norm_row.classList.add('normalized');
			make_exploded(norm_row, norm, true);
			add_row_tag(norm_row, create_class_tag(norm));
			output_div.append(norm_row, create_hashes_row(norm));
		}
		output_div.append(create_dns_row(norm));
		return true;
	} catch (err) {		
		stop_resolving();
		row.classList.add('error');
		let span = document.createElement('span');
		apply_grade(span, 'warn', err.message);
		span.classList.add('long');
		add_row_tag(row, span);
		let tokens = ens_tokenize(name).flatMap(token => token.type === 'nfc' ? token.tokens : token);
		if (tokens.some(x => x.type === 'disallowed')) {
			let btn = document.createElement('button');
			btn.innerHTML = 'Remove Disallowed';
			btn.addEventListener('click', () => {			
				input_field.value = String.fromCodePoint(...tokens.flatMap(token => {
					switch (token.type) {
						case 'disallowed': return [];
						case 'stop': return 0x2E;
						case 'valid': return token.cps;
						case 'emoji': return token.input;
						//case 'isolated':
						//case 'mapped':
						//case 'ignored':
						default: return token.cp;
					}
				}));
				resolve();
			});
			add_row_tag(row, btn);
		}		
	}
}

function add_transformed_row(input) {
	if (ens_tokenize(input).some(x => x.type === 'nfc' || x.type === 'mapped')) {
		let row = create_row('Mapped');
		row.classList.add('transform');
		make_exploded(row, input, true);
		row.querySelector('.tags').remove();
		output_div.append(row);
	}
}

function create_dns_row(ens_norm) {
	let row = create_row('DNS');
	row.classList.add('dns');
	try {
		let name = dns_from_normalized_ens(ens_norm);
		let idna;
		try {
			idna = new URL(`https://${ens_norm}`).host;
		} catch (ignored) {
		}

		let link = create_link(`https://${name}.limo`, name);
		link.style.overflowWrap = 'anywhere';
		row.append(link);

		let same = name === ens_norm;

		if (!same) {
			row.append(create_copy_btn(name));
		}

		let span = document.createElement('span');	
		if (same) {
			apply_grade(span, 'good', 'Verbatim');
		} else if (!idna || idna !== name) {
			span.classList.add('fail');
			span.innerHTML = '🛑 Pre-IDNA Punycode Required';
			if (idna) {
				add_row_tag(row, create_copy_btn(idna, 'Copy Mangled'));
			}
		} else {
			apply_grade(span, 'warn', 'Punycode Compatible');
		}
		add_row_tag(row, span);

		//row.append(create_link(`https://whois.uniregistry.net/rdap/domain/${name}.link`, 'WHOIS'));
	} catch (err) {
		row.classList.add('invalid');
		let span = document.createElement('span');
		apply_grade(span, 'fail', err.message);
		span.classList.add('long');
		add_row_tag(row, span);
	}
	return row;
}

function apply_escapes(s, forced) {
	return [...s].map(x => !forced && is_printable_ascii(x) ? x : `{${hex_cp(x.codePointAt(0))}}`).join('');
}

function replace_escapes(s) {
	// match: {HEX}, [0xHEX], [DEC]
	return s.replace(/(?:(?:\{([0-9a-f]+)\})|(?:\[((?:0x[0-9a-f]+)|[0-9]+)\]))/uig, (_, a, b, c) => {
		try {
			return String.fromCodePoint(a ? parseInt(a, 16) : parseInt(b)); 
		} catch (err) {
			return '\u{FFFD}';
		}
	});
}

function create_link(url, s) {
	let a = document.createElement('a');
	a.href = url;
	a.innerHTML = s ?? url;
	return a;
}

function create_etherscan_address_link(s, title) {
	let a = create_link(`https://etherscan.io/address/${s}`, title ?? s);
	a.classList.add('hash');
	return a;	
}

function create_copy_btn(s, title = 'Copy') {
	let btn = document.createElement('button');
	btn.addEventListener('click', () => navigator.clipboard.writeText(s));
	btn.innerHTML = title;
	btn.title = `${s}\n${explode_cp(s).map(hex_cp).join(' ')}`;
	return btn;
}

function create_resolve_btn(s) {
	let btn = document.createElement('button');
	btn.innerHTML = 'Resolve';	
	btn.title = s;
	btn.addEventListener('click', () => {
		input_field.value = s;
		resolve();
	});
	return btn;
}

function create_ens_link(s) {
	let a = create_link(`https://app.ens.domains/name/${encodeURIComponent(s)}`, 'ENS');
	a.classList.add('ens');
	a.title = `ENS: ${s}`;
	return a;
}

function get_dot_eth_label(name) {
	let v = name.split('.');
	return v.length == 2 && v[1].toLowerCase() == 'eth' ? v[0] : undefined;
}

function create_pretty_tag(short) {
	let span = document.createElement('span');
	span.classList.add('pretty');
	span.innerHTML = '💖️';
	span.title = 'Beautified Form';
	return span;
}

function add_dot_eth_links(row, name) {
	let label = get_dot_eth_label(name);
	if (!label) return ''; // only if 2LD .eth	
	let hash = labelhash(label);
	let contract = '0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85';
	
	let os = create_link(`https://opensea.io/assets/${contract}/${ethers.BigNumber.from(hash)}`, 'OpenSea');
	os.classList.add('opensea');
	add_row_tag(row, os);

	let meta = create_link(`https://metadata.ens.domains/mainnet/${contract}/${hash}`, 'Metadata');
	meta.classList.add('metadata');
	add_row_tag(row, meta);
}

function utf8_length(s) {
	let bytes = 0;
	for (let pos = 0, len = s.length; pos < len; ) {
		let cp = s.codePointAt(pos++);
		if (cp < 0x800) {
			bytes += cp < 0x80 ? 1 : 2;
		} else {
			if (cp < 0x10000) {
				bytes += 3;
			} else {
				bytes += 4;
				pos++;
			}
		}
	}
	return bytes;
}

function make_exploded(row, name, is_norm, downgrade_disallowed) {	
	let tokens_div = dom_from_tokens(ens_tokenize(name), !is_norm);
	if (downgrade_disallowed) {
		for (let x of tokens_div.querySelectorAll('.disallowed')) {
			x.classList.add('ignored');
			x.classList.remove('disallowed');
		}
	}
	/*
	let n_cp = [...name].length;
	let n_u8 = unescape(encodeURIComponent(name)).length; // this kinda sucks
	let count = document.createElement('span');
	count.classList.add('length');		
	//count.addEventListener('click', () => {
	//	input_field.value = apply_escapes(name);
	//});
	add_row_tag(row, count);
	if (n_cp != n_u8) {
		count.innerHTML = `${n_cp}<sub>ch</sub>`;	
		let bytes = document.createElement('span');
		bytes.classList.add('bytes');
		bytes.innerHTML = `${n_u8}<sub>bytes</sub>`;
		add_row_tag(row, bytes); 
	} else {
		count.innerHTML = `${n_cp}<sub>chytes</sub>`;
		count.title = '1-byte Characters';
	}	
	*/
	let bytes = document.createElement('span');
	bytes.classList.add('bytes');
	bytes.innerHTML = `${utf8_length(name)}<sub>bytes</sub>`;
	add_row_tag(row, bytes); 
	
	let exploded = document.createElement('div');
	exploded.classList.add('exploded');
	exploded.append(tokens_div, row.querySelector('.tags'));
	row.append(exploded);
}

function apply_grade(span, type, s) {
	span.classList.remove(...span.classList);
	span.classList.add(type);
	switch (type) {
		case 'warn': 
			span.innerHTML = `⚠️ ${s}`;
			break;
		case 'best': 
			span.innerHTML = `✅️ ${s}`;
			break;
		case 'good': 
			span.innerHTML = s;
			break;
		case 'fail': 
			span.innerHTML = `❌ ${s}`;
			break;
	}
}

function create_class_tag(name) {
	let span = document.createElement('span');
	let tokens = ens_tokenize(name);
	let cps = tokens.flatMap(token => {
		return token.type === 'nfc' ? token.tokens : token;
	}).flatMap(token => {
		switch (token.type) {
			case 'disallowed':
			case 'mapped': 
			case 'ignored':  return token.cp;
			case 'valid': return token.cps;
			default: return [];
		}
	});
	let tags = [];
	if (cps.every(cp => cp < 0x80)) {
		if (/^[a-z0-9.]*$/u.test(String.fromCodePoint(...cps))) {
			tags.push('Basic');
		} else {
			tags.push('ASCII');
		}
	} else {
		tags.push('Unicode');
	}
	if (tokens.some(token => token.type === 'emoji')) {
		tags.push('Emoji');
	}
	span.classList.add('okay');
	span.innerHTML = tags.join('+');
	return span;
}

function create_hashes_row(name) {
	let row = create_row();
	row.classList.add('hashes');
	row.classList.toggle('hide', !show_hashes_check.checked);
	// build table of label hashes
	for (let label of name.split('.')) {
		let cps = explode_cp(label);
		let text = document.createElement('span');
		text.classList.add('text');
		text.innerHTML = label;
		let len = document.createElement('span');
		len.classList.add('length');
		len.innerHTML = `${cps.length}<sub>ch</sub>`;
		let hex = document.createElement('span');
		hex.classList.add('cp');
		hex.innerHTML = cps.length == 0 ? '«null»' : [...cps].map(hex_cp).join(' ');
		let hash = document.createElement('span');
		hash.classList.add('hash');
		hash.innerHTML = labelhash(label);
		row.append(text, len, hex, hash);
	}
	// add namehash
	let hash = document.createElement('span');
	hash.classList.add('name', 'hash');
	hash.innerHTML = `<b>Namehash:</b> ${namehash(name)}`;
	row.append(hash);
	return row;
}

function create_row(label, waiting) {
	let row = document.createElement('div');
	row.classList.add('row');
	if (label) {
		let span = document.createElement('span');
		span.classList.add('row-label');
		span.innerHTML = `${label}:`;
		row.append(span);
	}
	if (waiting) {
		let div = document.createElement('div');
		div.classList.add('temporary');
		div.innerHTML = '<div class="arrows"></div>';
		row.append(div);
	}
	return row;
}

function remove_temporary(row) {
	for (let x of row.querySelectorAll('.temporary')) {
		x.remove();
	}
}

function add_row_tag(row, tag) {
	if (!tag) return;
	let tags = row.querySelector('.tags');
	if (!tags) {
		tags = document.createElement('div');
		tags.classList.add('tags');
		row.append(tags);
	}
	tags.append(tag);
	return true;
}

function trim_trailing_decimal_zeros(s) {
	let match = s.match(/^(.*)\.0+$/);
	if (match) return match[1];
	return s;
}
function format_dur(t) {
	if (t < 1000) return `${Math.ceil(t)}ms`;
	t /= 1000;
	if (t < 60) return `${trim_trailing_decimal_zeros(t.toFixed(1))}s`;
	t /= 60;
	if (t < 60) return `${trim_trailing_decimal_zeros(t.toFixed(1))}m`;
	t /= 60;
	if (t < 24) return `${trim_trailing_decimal_zeros(t.toFixed(1))}h`;
	t /= 24;
	return `${trim_trailing_decimal_zeros(t.toFixed(1))}d`;
}

function is_working() {
	return resolve_btn.disabled;
}

function resolve(options) {
	if (!options) {
		options =  {
			skip_norm: skip_norm_check.checked
		};
	}
	if (is_working()) {
		resolve_timer = RESOLVE_MODE_REPEAT; 
		resolve_options = options;
		return;
	}
	clearTimeout(resolve_timer);
	resolve_timer = RESOLVE_MODE_IDLE;
	let input = input_field.value;
	try {
		let url = new URL(input);
		if (url.hostname == 'opensea.io') {
			// https://opensea.io/assets/ethereum/0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85/91842011529764390124322931916134555051359118325819011691525342013207339157209
			let v = url.pathname.toLowerCase().split('/').filter(x => x);
			if (v[0] === 'assets' && v[1] === 'ethereum' && v[2] === '0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85' && /^\d+$/.test(v[3])) {
				resolve_btn.disabled = true;
				primary_arrows.classList.remove('hide');
				fetch(`https://metadata.ens.domains/mainnet/0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85/${v[3]}`).then(r => {
					if (r.status !== 200) throw new Error(`HTTP Error ${r.status}`);
					return r.json();
				}).then(meta => {				
					input_field.value = meta.name;
					setTimeout(resolve, 0);
				}).catch(() => {}).finally(() => {
					resolve_btn.disabled = false;
				});
				return;
			}
		}
	} catch (err) {		
	}
	if (!options.automatic && /^\s*[0-9a-f]{2,}(\s+[0-9a-f]{2,})+\s*$/i.test(input)) {
		input_field.value = input = input.trim().split(/\s+/).map(x => `{${x}}`).join('');	
	}
	let title = 'ENS Resolver';
	if (!input) {
		if (window.location.hash) {
			window.history.pushState(null, null, ' ');
		} else {
			window.history.replaceState(null, null, ' ');
		}
		document.title = title;
		parse();
		return;
	}
	title += `: ${input}`;
	let hash = '#' + encodeURIComponent(input);
	if (options.skip_norm) {
		hash += SKIP_SUFFIX;
		title += ' (!)';
	}
	document.title = title;
	if (window.location.hash != hash) {
		window.history.pushState(null, null, hash);
	}
	if (!options.skip_norm && !parse()) {
		primary_arrows.classList.add('hide');
		return;
	}
	resolve_btn.disabled = true;
	primary_arrows.classList.remove('hide');
	resolve_date0 = new Date();
	resolve0(input, options.skip_norm).then(() => {
		resolve_btn.disabled = false;
		if (resolve_timer === RESOLVE_MODE_REPEAT) { 
			setTimeout(resolve, 0, resolve_options);
		} else {
			primary_arrows.classList.add('hide');
		}
	});
}


function create_elapsed() {
	let now = new Date();
	let span = document.createElement('span');
	span.classList.add('elapsed');
	span.innerHTML = format_dur(now - resolve_date0);
	resolve_date0 = now;
	return span;
}

async function resolve0(input0, skip_norm) {
	output_div.innerHTML = '';

	// replace escapes
	let input = replace_escapes(input0);
	let input_is_address = is_checksum_address(input);
	let input_grade = document.createElement('span');
	let input_row;
	let normed_row;
	let name_norm;

	if (input_is_address) {

		// the input is an address
		input_row = create_row('Address');
		input_row.append(create_etherscan_address_link(input));
		// note: input_grade not added yet
		output_div.append(input_row);
		
		// lookup the address
		let primary;
		let reverse_row = normed_row = create_row('Reverse', true);
		output_div.append(reverse_row);
		try {
			primary = await active_provider.lookupAddress(input);
		} catch (err) {			
			reverse_row.classList.add('error');
			let span = document.createElement('span');
			apply_grade(span, 'warn', err.message);
			span.classList.add('long');
			add_row_tag(reverse_row, span);
			return; // network error, nothing more we can do
		} finally {
			remove_temporary(reverse_row);
		}
		if (should_stop_resolving()) return;
		add_row_tag(reverse_row, create_elapsed());

		// primary not set
		if (!primary) {
			let span = document.createElement('span');
			apply_grade(span, 'warn', 'Primary Not Set');
			add_row_tag(reverse_row, span);
			return;
		}

		// primary exists!
		make_exploded(reverse_row, primary, false);
		add_row_tag(reverse_row, create_class_tag(primary));
		output_div.append(create_hashes_row(primary));
			
		// lets check if it's normalized
		try {
			name_norm = ens_normalize(primary);
		} catch (err) {
			reverse_row.classList.add('error');
			let span = document.createElement('span');
			apply_grade(span, 'warn', `Invalid name: ${err.message}`);
			add_row_tag(reverse_row, span);
			return;
		}
		
		// primary was normalized
		if (name_norm === primary) {
			reverse_row.classList.add('normalized');
			//let span = document.createElement('span');
			//apply_grade(span, 'good', 'Normalized');
			//add_row_tag(reverse_row, span);
			add_row_tag(reverse_row, create_resolve_btn(primary));

		// primary was valid but wasn't normalized 
		} else if (name_norm) {
			// mark the reverse as bad
			let span = document.createElement('span');
			apply_grade(span, 'fail', 'Normalized');
			add_row_tag(reverse_row, span);
			// create norm now
			let row = normed_row = create_row('Normalized Reverse');
			row.classList.add('normalized');
			make_exploded(row, name_norm, true);
			add_row_tag(row, create_copy_btn(name_norm));
			add_row_tag(row, create_resolve_btn(name_norm));
			output_div.append(row);
			output_div.append(create_hashes_row(name_norm));
		}	

	} else {
		
		// the input is a name
		input_row = normed_row = create_row('Name');
		make_exploded(input_row, input, false);
		add_row_tag(input_row, create_class_tag(input));
		//add_row_tag(input_row, input_grade);
		add_row_tag(input_row, create_ens_link(input));
		output_div.append(input_row);
		output_div.append(create_hashes_row(input));

		// lets check if it's normalized
		
		if (input !== input0) {
			add_row_tag(input_row, create_copy_btn(input));
		}
		
		if (skip_norm) {
			let row = create_row('Normalization');
			row.classList.add('skipped');
			let span = document.createElement('span');
			apply_grade(span, 'fail', 'Skipped');
			add_row_tag(row, span);
			//if (input !== input0) {
				let unnorm = document.createElement('span');
				unnorm.classList.add('main', 'long');
				unnorm.innerHTML = input;
				row.append(unnorm);
			//}
			output_div.append(row);
			add_dot_eth_links(input_row, input);
			//add_row_tag(input_row, create_opensea_link(input));
			name_norm = input; // yolo
		} else {

			try {
				name_norm = ens_normalize(input);
			} catch (err) {
				input_row.classList.add('error');
				apply_grade(input_grade, 'warn', err.message);
				add_row_tag(input_row, input_grade);
				//input_grade.parentNode.prepend(input_grade); // move to front
				return;
			}	
		
			add_transformed_row(input);
	
			// name was normalized
			if (name_norm === input) {
				input_row.classList.add('normalized');
				//apply_grade(input_grade, 'good', 'Normalized');
				//add_row_tag(input_row, input_grade);
				//add_row_tag(input_row, create_opensea_link(input));
				add_dot_eth_links(input_row, input);
			} else if (name_norm) {
				// mark the name as bad
				let span = document.createElement('span');
				apply_grade(span, 'fail', 'Normalized');
				add_row_tag(input_row, span);
				input_row.querySelector('.ens').remove(); // pointless
				// create norm row
				let row = normed_row = create_row('Normalized');
				row.classList.add('normalized');
				make_exploded(row, name_norm, true);
				add_row_tag(row, create_class_tag(name_norm));
				add_row_tag(row, create_copy_btn(name_norm));
				add_row_tag(row, create_resolve_btn(name_norm));
				add_row_tag(row, create_ens_link(name_norm));
				//add_row_tag(row, create_opensea_link(name_norm));
				add_dot_eth_links(row, name_norm);
				output_div.append(row);
				output_div.append(create_hashes_row(name_norm));
			}
		}
	}

	let eth_label = get_dot_eth_label(name_norm);
	if (eth_label) {
		let tokens = ens_tokenize(eth_label);
		if (tokens.every(t => t.type === 'emoji')) {
			let ethmoji_row = create_row('Ethmoji');
			ethmoji_row.classList.add('ethmoji');
			let unique = new Set();
			let grouped = [];
			let last;
			for (let token of tokens) {
				let form = String.fromCodePoint(...token.emoji);
				unique.add(form);
				if (!last || last.form !== form) {
					grouped.push(token);
					token.count = 1;
					token.form = form;
					last = token;
				} else {
					last.count++;
				}
			}
			let formula = document.createElement('code');
			formula.innerHTML = grouped.map(token => {
				return `${token.form}<sup>${token.count}</sup>`;
			}).join('');
			ethmoji_row.append(formula);
			
			let grade = document.createElement('span');
			if ([...eth_label].length < 3) {
				grade.innerHTML = 'Too Short';
			} else if (tokens.every(t => t.emoji[2] == 0x20E3)) {
				if (tokens.length == 2) {
					grade.classList.add('best');
					grade.innerHTML = '🔥️ Shortest Keycaps';
				} else {
					grade.classList.add('warn');
					grade.innerHTML = `⭐️ Keycaps`;
				}
			} else if (unique.size == 1) {
				let ncp = last.cps.length;
				if ((ncp == 1 && last.count == 3) || (ncp == 2 && last.count == 2) || (ncp >= 3 && last.count == 1)) {
					grade.classList.add('best');
					grade.innerHTML = '🔥️ Shortest';
				} else {
					grade.classList.add('warn');
					grade.innerHTML = '⭐️ Repeated';
				}
			} else {
				grade.innerHTML = `Mixed: ${unique.size}`;
			}
			add_row_tag(ethmoji_row, grade);

			let mirror = true;
			for (let a = 0, b = grouped.length - 1; a < b; a++, b--) {
				if (grouped[a].form !== grouped[b].form) {
					mirror = false;
					break;
				}
			}
			if (mirror) { //&& unique.size > 1) {
				let span = document.createElement('span');
				span.innerHTML = '⇄ Palindrome';
				add_row_tag(ethmoji_row, span);
			}
			output_div.append(ethmoji_row);
		}
	}


	if (!skip_norm) {
		let pretty = ens_beautify(name_norm);
		
		let row = create_row('Beautified');
		row.classList.add('pretty');
		let span = document.createElement('span');
		span.classList.add('main');
		span.innerHTML = pretty;
		row.append(span);
		add_row_tag(row, create_copy_btn(pretty));
		add_row_tag(row, create_resolve_btn(pretty));
		add_row_tag(row, create_pretty_tag(true));
		
		if (input === pretty) { 
			add_row_tag(input_row, create_pretty_tag());
			let span = document.createElement('span');
			apply_grade(span, 'good', 'Same as Input');
			add_row_tag(row, span);
		} else if (name_norm === pretty) {			
			add_row_tag(normed_row, create_pretty_tag());
			let span = document.createElement('span');
			apply_grade(span, 'good', 'Same as Normalized');
			add_row_tag(row, span);
		}
		

		output_div.append(row);
	}

	output_div.append(create_dns_row(name_norm));

	// at this point, we have a name
	// lookup the name
	let resolver;
	let resolver_row = create_row('Resolver', true);
	output_div.append(resolver_row);
	try {
		resolver = await active_provider.getResolver(name_norm);
	} catch (err) {
		remove_temporary(resolver_row);
		resolver_row.classList.add('error');
		let span = document.createElement('span');
		apply_grade(span, 'warn', err.message);
		span.classList.add('long');
		add_row_tag(resolver_row, span);
		return;	
	}
	if (should_stop_resolving()) return;
	
	// name doesn't exist
	if (!resolver) { 
		remove_temporary(resolver_row);
		let span = document.createElement('span');
		apply_grade(span, 'warn', `Name Not Found`);
		add_row_tag(resolver_row, span);
		add_row_tag(resolver_row, create_elapsed());

		// check if *.eth
		let check_nft;
		if (eth_label) {
			let hash = ethers.utils.id(eth_label);
			let avail_row = create_row('Availability', true);
			output_div.append(avail_row);
			try {
				await ensure_eth_nft();
				let span_avail = document.createElement('span');
				add_row_tag(avail_row, span_avail);
				let len = [...eth_label].length;
				if (len < 3) {
					apply_grade(span_avail, 'fail', `Too Short`);
				} else {
					let available = await eth_nft_contract.callStatic.available(hash);
					if (available) {
						apply_grade(span_avail, 'good', 'Available');
					} else {
						apply_grade(span_avail, 'fail', `Not Available`);
						let t_exp = (await eth_nft_contract.callStatic.nameExpires(hash)).toNumber();
						let t_end = t_exp + eth_nft_contract.grace_period;
						let t_now = Math.round(Date.now() / 1000);
						if (t_now >= t_exp && t_now <= t_end) {
							let days = (t_end - t_now) / 86400;
							let span = document.createElement('span');
							span.innerHTML = `Grace period (${format_dur(1000 * eth_nft_contract.grace_period)}) ends in ${format_dur(1000 * (t_end - t_now))}`;
							add_row_tag(avail_row, span);
						} else {
							if (t_exp - t_now < 86400 * 60) {
								let span = document.createElement('span');
								span.innerHTML = `Expires in ${format_dur(1000 * (t_exp - t_now))}`;
								add_row_tag(avail_row, span);
							}
							check_nft = true;
						}
					}
				}
				let span_len = document.createElement('span');
				span_len.classList.add('bytes'); 
				span_len.innerHTML = `${len}<sub>ch</sub>`;
				add_row_tag(avail_row, span_len);
				add_row_tag(avail_row, create_ens_link(name_norm));	
				add_row_tag(avail_row, create_etherscan_address_link(eth_nft_contract.address, 'NFT'));	
			} catch (err) {
				avail_row.classList.add('error');
				let span = document.createElement('span');
				apply_grade(span, 'warn', err.message);
				span.classList.add('long');
				add_row_tag(avail_row, span);
			} finally {
				remove_temporary(avail_row);
			}
			add_row_tag(avail_row, create_elapsed());
			if (should_stop_resolving()) return;

			if (check_nft) {
				let nft_row = create_row('NFT Owner', true);
				output_div.append(nft_row);
				try {
					let nft_owner = await eth_nft_contract.callStatic.ownerOf(hash);	
					nft_row.append(create_etherscan_address_link(nft_owner));
					add_row_tag(nft_row, create_copy_btn(nft_owner));
					add_row_tag(nft_row, create_resolve_btn(nft_owner));
				} catch (err) {
					nft_row.classList.add('error');
					let span = document.createElement('span');
					apply_grade(span, 'warn', err.message);
					span.classList.add('long');
					add_row_tag(nft_row, span);
				} finally {
					remove_temporary(nft_row);
				}
				add_row_tag(nft_row, create_elapsed());
			}
		}			
		return;
	}

	let is_wildcard = await resolver.supportsWildcard();
	let resolver_name = resolver.address;
	if (is_wildcard) {
		// ethers doesn't expose this information
		let v = name_norm.split('.');
		try {
			while (true) {
				let parent = v.join('.');
				let address = await registry_contract.callStatic.resolver(namehash(parent));
				if (should_stop_resolving()) return;
				if (address === resolver.address) {
					resolver_name = parent;
					break;
				}	
				v.shift();
			}
		} catch (ignored) {			
		}
	} else if (resolver_name === '0x4976fb03C32e5B8cfe2b6cCB31c09Ba78EBaBa41') {
		resolver_name = 'Public Resolver';
	}	
	resolver_row.append(create_etherscan_address_link(resolver.address, resolver_name));
	
	if (is_wildcard) {
		let span = document.createElement('span');
		span.classList.add('wildcard');
		span.innerHTML = 'Wildcard';
		add_row_tag(resolver_row, span);
	}
	add_row_tag(resolver_row, create_copy_btn(resolver.address));
	add_row_tag(resolver_row, create_elapsed());
	remove_temporary(resolver_row);
	

	/*
	// check the display name
	let display_name;
	let display_row = create_row('Display', true);
	output_div.append(display_row);
	try {
		display_name = await name.get_text('display');
	} catch (err) {
		display_row.classList.add('error');
		let span = document.createElement('span');
		apply_grade(span, 'warn', err.message);
		span.classList.add('long');
		add_row_tag(display_row, span);
	} finally {
		remove_temporary(display_row);
	}
	if (resolve_timer) return;
	add_row_tag(display_row, create_elapsed());

	if (typeof display_name === 'string') {
		if (!display_name) {
			let span = document.createElement('span');
			apply_grade(span, 'warn', `Not Set`);
			add_row_tag(display_row, span);
		} else {
			try {
				let display_norm = ens_normalize(display_name);
				display_row.classList.add('display');
				if (display_norm === name_norm) { // display is valid
					make_exploded(display_row, [{v:explode_cp(display_name)}], true); // fake display
					if (!input_is_address && input === display_name) { // input matches display
						apply_grade(input_grade, 'best', 'Matches Display');
						input_row.classList.add('display');
						input_row.querySelector('.ens')?.remove(); // no purpose
						input_row.querySelector('.opensea')?.remove(); // no purpose
						let span = document.createElement('span');
						span.innerHTML = 'Same as Input';
						add_row_tag(display_row, span);				
					}
				} else { // the display norm is goofy
					make_exploded(display_row, display_norm, true);
					let span = document.createElement('span');
					apply_grade(span, 'warn', `Does Not Match`);
					add_row_tag(display_row, span);
				}
			} catch (err) { // the display doesn't normalize
				make_exploded(display_row, display_name, false);
				let span = document.createElement('span');
				apply_grade(span, 'fail', err.message);
				add_row_tag(display_row, span);
			}
		}
	}
	*/

	// get the owner
	let owner;
	if (!is_wildcard) {
		//owner = await resolver._fetch('0x02571be3'); // owner(bytes32)
		//owner = await resolver._fetch('0x38a699a4'); // exists(bytes32)
		//owner = await resolver._fetch('0x7dd56411'); // ownerOf(bytes32)
		let owner_row = create_row('Owner', true);
		output_div.append(owner_row);
		try {
			owner = await registry_contract.callStatic.owner(namehash(name_norm));
		} catch (err) {
			owner_row.classList.add('error');
			let span = document.createElement('span');
			apply_grade(span, 'warn', err.message);
			span.classList.add('long');
			return; // required to continue
		} finally {
			remove_temporary(owner_row);
		}
		if (should_stop_resolving()) return;

		// we got the owner
		owner_row.classList.add('owner');
		owner_row.append(create_etherscan_address_link(owner));
		add_row_tag(owner_row, create_copy_btn(owner));
		add_row_tag(owner_row, create_elapsed());

		// if the input was an address, we can validate
		if (input_is_address) {
			if (owner === input) {
				apply_grade(input_grade, 'best', 'Owner');
				add_row_tag(input_row, input_grade);
				let span = document.createElement('span');
				span.innerHTML = 'Same as Input';
				add_row_tag(owner_row, span);
			} else {
				apply_grade(input_grade, 'fail', 'Different from Owner');
				add_row_tag(input_row, input_grade);
			}
		}
		if (owner !== input) {
			add_row_tag(owner_row, create_resolve_btn(owner));
		}

		if (eth_label) {
			let row = create_row('Controller', true);
			output_div.append(row);
			let controller;
			try {
				await ensure_eth_nft();
				controller = await eth_nft_contract.callStatic.getApproved(labelhash(eth_label));
			} catch (err) {				
			}
			if (should_stop_resolving()) return;
			if (!controller || is_null_hex(controller)) {
				row.remove();
			} else {
				row.append(create_etherscan_address_link(controller));
				add_row_tag(row, create_elapsed());
				remove_temporary(row);
			}
		}
	}

	// add address
	let address;
	let address_row = create_row('ETH Address', true);
	address_row.classList.add('addr');
	output_div.append(address_row);	
	try {
		address = await resolver.getAddress();
		if (is_null_hex(address)) address = false;
	} catch (err) {
		address_row.classList.add('error');
		let span = document.createElement('span');
		apply_grade(span, 'warn', err.message);
		span.classList.add('long');
		add_row_tag(address_row, span);
	} finally {
		remove_temporary(address_row);
	}
	if (should_stop_resolving()) return;
	
	if (!address) {
		let span = document.createElement('span');
		apply_grade(span, 'warn', 'Not Set');
		add_row_tag(address_row, span);
	} else {
		address_row.append(create_etherscan_address_link(address));
		if (input_is_address) {
			if (address === input) {
				let span = document.createElement('span');
				span.innerHTML = 'Same as Input';
				add_row_tag(address_row, span);
			} else if (address) {
				add_row_tag(address_row, create_copy_btn(address));
				add_row_tag(address_row, create_resolve_btn(address));
				let span = document.createElement('span');
				apply_grade(span, 'warn', 'Different from Owner');
				add_row_tag(address_row, span);	
			}
		} else {
			if (owner === address) {
				let span = document.createElement('span');
				apply_grade(span, 'good', 'Same as Owner');
				add_row_tag(address_row, span);	
			} else {
				add_row_tag(address_row, create_copy_btn(address));
				add_row_tag(address_row, create_resolve_btn(address));
				if (owner) {
					let span = document.createElement('span');
					apply_grade(span, 'warn', 'Not Owner');
					add_row_tag(address_row, span);	
				}
			}
		}
	}
	add_row_tag(address_row, create_elapsed());	
	if (input_is_address || !address) return; // nothing more to do

	// lookup primary from eth address 
	let primary;
	let primary_row = create_row('Primary', true);
	output_div.append(primary_row);
	try {
		primary = await active_provider.lookupAddress(address);
	} catch (err) {
		primary_row.classList.add('error');
		let span = document.createElement('span');
		apply_grade(span, 'warn', err.message);
		span.classList.add('long');
		add_row_tag(primary_row, span);
		return;
	} finally {
		remove_temporary(primary_row);
	}
	if (should_stop_resolving()) return;
	add_row_tag(primary_row, create_elapsed());

	// primary not set
	if (!primary) {
		let span = document.createElement('span');
		apply_grade(span, 'warn', 'Not Set');
		add_row_tag(primary_row, span);
		return;
	}

	// primary exists
	make_exploded(primary_row, primary, false);
	add_row_tag(primary_row, create_class_tag(primary));
	output_div.append(create_hashes_row(primary));

	// lets check if it's normalized
	let primary_norm;
	try {
		primary_norm = ens_normalize(primary);
	} catch (err) {
		primary_row.classList.add('error');
		let span = document.createElement('span');
		apply_grade(span, 'warn', `Invalid name: ${err.message}`);
		add_row_tag(primary_row, span);
	}
	
	// primary was normalized
	if (primary === primary_norm) {
		primary_row.classList.add('normalized');
		//let span = document.createElement('span');
		//apply_grade(span, 'good', 'Normalized');
		//add_row_tag(primary_row, span);
		if (name_norm !== primary_norm) {
			add_row_tag(primary_row, create_copy_btn(primary_norm));
			add_row_tag(primary_row, create_resolve_btn(primary_norm));
			add_row_tag(primary_row, create_ens_link(primary_norm));
			add_dot_eth_links(primary_row, primary_norm);
		}

	// primary was valid but not normalized
	} else if (primary_norm) {
		// mark the name as bad
		let span = document.createElement('span');
		apply_grade(span, 'fail', 'Normalized');
		add_row_tag(primary_row, span);
		// create norm row
		let row = create_row('Normalized Primary');
		row.classList.add('normalized');
		make_exploded(row, primary_norm, true);
		add_row_tag(row, create_class_tag(primary_norm));
		add_row_tag(row, create_copy_btn(primary_norm));
		add_row_tag(row, create_ens_link(primary_norm));
		add_dot_eth_links(row, primary_norm);
		//add_row_tag(row, create_opensea_link(primary_norm));
		if (name_norm !== primary_norm) {
			add_row_tag(row, create_resolve_btn(primary_norm));
		}

		output_div.append(row);
		output_div.append(create_hashes_row(primary_norm));
	}	

	if (primary_norm && name_norm === primary_norm && !input_grade.classList.contains('best')) {
		apply_grade(input_grade, 'best', 'Primary');
		add_row_tag(input_row, input_grade);
	}
}

async function ensure_eth_nft() {
	if (eth_nft_contract) return;
	// https://docs.ens.domains/contract-api-reference/.eth-permanent-registrar
	let resolver = await active_provider.getResolver('eth');
	if (!resolver) throw new Error(`No .eth resolver`);
	eth_nft_contract = new ethers.Contract(await resolver.getAddress(), [
		`function available(uint256 id) external view returns(bool)`,
		`function nameExpires(uint256 id) external view returns(uint256)`,
		`function ownerOf(uint256 id) external view returns (address)`,
		`function getApproved(uint256 id) external view returns (address)`,
		`function GRACE_PERIOD() external view returns (uint256)`,
	], active_provider);
	eth_nft_contract.grace_period = (await eth_nft_contract.callStatic.GRACE_PERIOD()).toNumber();
}

function is_checksum_address(s) {
	try {
		return s === ethers.utils.getAddress(s);
	} catch (ignored) {		
	}
}
function is_null_hex(s) {
	return /^0x0*$/.test(s);
}
function labelhash(s) {
	return ethers.utils.id(s);
}
function namehash(s) {
	let hash = '0x0000000000000000000000000000000000000000000000000000000000000000';
	if (s) hash = s.split('.').reduceRight((h, x) => ethers.utils.keccak256(h + ethers.utils.id(x).slice(2)), hash);
	return hash.slice(0, 66);
}
</script>
</body>
</html>
