<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ENS Resolver</title>
<style>
:root {
	--length-color: #f8eedd;
}
.hide {
	display: none !important;
}
.long {
	white-space: pre-wrap !important;
	line-break: anywhere;
}
a, button {
	cursor: pointer;
}
body { 
	margin: 3rem; 
	background: #eee;
	display: flex;
	flex-direction: column;
	gap: 0.7rem;
	overflow-y: scroll;
}
header {
	display: flex;
	justify-content: space-between;
}
h1 {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	margin: 0;
	gap: 0.2rem;
}
h1 a {
	font-size: 24pt;
	white-space: pre;
}
h2 {
	margin: 0;
	font-size: 16pt;
}
#provider {
	font-size: 11pt;
	font-weight: normal;
	color: #666;
}
#version {
	text-align: right;
	box-sizing: border-box;
	width: min-content;
}
#version a {	
	white-space: pre;
}
.arrows {
	width: 2rem;
	padding-bottom: 100%;
	animation: spin 2s infinite linear;
	user-select: none;
	background-image: url('data:image/svg+xml;utf8,%3Csvg%20viewBox%3D%220%200%201000%201000%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M990%2C377.5H622.5l137.4-137.4C690.4%2C170.7%2C598.2%2C132.5%2C500%2C132.5c-98.2%2C0-190.4%2C38.2-259.9%2C107.6C170.7%2C309.6%2C132.5%2C401.8%2C132.5%2C500c0%2C98.2%2C38.2%2C190.4%2C107.6%2C259.9c69.4%2C69.4%2C161.7%2C107.6%2C259.9%2C107.6c98.2%2C0%2C190.4-38.2%2C259.9-107.6c5.8-5.8%2C11.4-11.8%2C16.7-17.9l92.2%2C80.7C778.9%2C925.2%2C647%2C990%2C500%2C990C229.4%2C990%2C10%2C770.6%2C10%2C500C10%2C229.4%2C229.4%2C10%2C500%2C10c135.3%2C0%2C257.8%2C54.9%2C346.5%2C143.5L990%2C10V377.5z%22%2F%3E%3C%2Fsvg%3E');
	background-size: contain;
	background-repeat: no-repeat;
}
@keyframes spin {
	from { transform:rotate(0deg); }
	to { transform:rotate(360deg); }
}
#examples {
	display: flex;
	flex-wrap: wrap;
	align-items: center;
	gap: 3px;
}
#examples a {
	background-color: #ffc;
}
#input label {
	display: none;
}
#input input {
	box-sizing: border-box;
	width: 100%;
	padding: 0.5rem;
	font-size: 16pt;
}
#controls {
	display: flex;
	flex-wrap: wrap;
	justify-content: flex-end;
	align-items: center;
	gap: 0.5rem;
}
#controls button {
	align-self: stretch;
	padding: 0.2rem;
}
input[type=checkbox], label {
	user-select: none;
	cursor: pointer;
}
input[type=checkbox]:checked + label.nonstd {
	background: #f00;
	color: #fff;
	outline: 2px solid #f00;
	border-radius: 5px;
}
#controls .balloon {
	flex-grow: 1;
}
#resolve_btn {
	font-size: 16pt;
	font-weight: bold;
}
#controls.hide + #output {	
	margin-top: 0.5rem;
}
#output {
	display: flex;
	flex-direction: column;
	gap: 0.7rem;
	font-size: 14pt;
}
.row-label {
	text-align: right;
	font-weight: bold;
	white-space: pre-wrap;
}
.row .arrows {
	width: 1.5rem;
}
.row {
	padding: 0.7rem;
	background: #fff;
	display: flex;
	flex-wrap: wrap;
	align-items: center;
	gap: 0.5rem;
}
.row.display {
	background: #eff;
}
.row.normalized {
	background: #efe;
}
.row.addr {
	background: #fffff0;
}
.row.dns {
	background:#f5faff; 
}
.row.old {
	opacity: 65%;
}
.row.old:not(.details) {
	outline: 1px solid #ccc;
}
.row.dns .main {
	border-bottom-style: dotted;
}
.row.dns.invalid {
	background: #fff0f0;	
	outline: 3px dashed #fcc;
}
.row.pretty {
	background: linear-gradient(90deg, #fff, #fff0fc);
}
.row.category {
	background: linear-gradient(90deg,#fff,#efe);
}
.formula {
	display: flex;
	flex-wrap: wrap;
	gap: 2px;
}
.formula a {
	padding: 4px;
	cursor: pointer;
	color: #000;
	text-decoration: none;
}
.formula a:hover {
	background: #cff;
}
.formula a sup {
	font-family: monospace;
}
.row .main {
	display: inline;
	font-size: 16pt;
	border-bottom: 2px solid #000;
	line-height: 130%;
}
ul.row {
	margin: 0;
	padding-left: 2rem;
	flex-direction: column;
	align-items: start;
}
ul .tokens {
	display: inline-flex;
}
.row.readme {
	background: #ffc;
}
.row.readme code {
	background: #cff;
	padding: 1px;
}
.row.legend {
	background: none;
	gap: 2px;
}
.row.links {
	display: grid;	
	gap: 0.5rem 0.5rem;
	list-style: disclosure-closed;
	grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
}
a.wide {
	line-break: anywhere;
}
sub {
	user-select: none;
}
span.tags {
	background: #ddd;
	color: #555;
	padding: 0.3rem;
	font-size: 12pt;
	border-radius: 0.5rem;
	border: 1px solid #ccc;
	white-space: pre;
}
button.tags {
	align-self: stretch;
}
.tags.long { order: 30; }
.tags.ens { order: 8; }
.tags.metadata { order: 9; }
.tags.third-party { order: 10; font-size: 80%; }
.tags.invalid { color: #f00; }
.tags.elapsed {
	background: #cff;
	font-size: 75%;
	order: 20;
}
.tags.length {
	background: var(--length-color);
}
.tags.good {
	color: #060;
	background: #cfc;
}
.tags.fire {
	color: #000;
	background: #fdb;
}
.tags.warn {
	background: #ffc;
}
.tags.second {
	background: #fff0dd;
}
.tags.fail {
	background: #fcc;
	color: #600;
}
.tags.special {
	background: #f84;
	border: none;
	color: #fff;
}
.tags.clean {
	background: none;
	border: none;
	padding: 0;
	font-size: 110%;
	order: 7;
}
.tags.palindrome {
	background: #dfd;
}
.tags.white {
	color: #000;
	background: #fff;
}
.row.details {
	display: grid;
	background: none;
	padding: 0;
	grid-template-columns: 2fr min-content 3fr;
	align-items: start;
	gap: 0.3rem;
	font-size: 12pt;
	box-sizing: border-box;
	margin-top: -0.2rem;
}
.details a.namehash {
	color: #000;
	font-weight: bold;
	text-decoration: none;
}
.details a.namehash:hover {
	text-decoration: underline;
}
.details button {
	white-space: pre;
	font-size: 80%;
}
.details .length {
	color: #777;
	background: var(--length-color);
	border: 1px solid #ccc;
	text-align: center;
	padding: 2px 4px;
	border-radius: 5px;
}
.details .label {
	font-size: 14pt;
	display: flex;
	text-align: center;
}
.details .label br {
	display: none;
}
.details .label .text {
	flex: 1;
}
.details .label.error {
	background: linear-gradient(90deg, #fcc, #eee);
}
.details code {
	font-size: 90%;
}
.details code,
.details .label {	
	max-height: 10rem;
	overflow-y: auto;
}
.details .script {
	color: #666; /*#83b;*/
	font-style: italic;
	padding-right: 5px;
	font-size: 85%;
	flex: 0 0 80px;
	text-align: left;
}
.details .disabled {
	color: #999;
	user-select: none;
}
.details .wide {
	grid-column: 1 / -1;
	text-align: center;
	line-break: anywhere;
	padding-bottom: 2px;;
	border-bottom: 3px solid #fff;
} 
.details .wide:first-child {
	padding-bottom: 5px;
}
.details .wide:last-child {
	border-bottom: none;
}
.details .footer {
	font-size: 90%;
	color: #666;
	padding: 0.2rem 0;
	border-top: 1px dotted #aaa;
}
.details .footer .error {
	color: #d00;
	font-size: 11pt;
	font-weight: bold;	
	background: #fee;;
}
.tokens {
	font-size: 16pt;
	align-self: stretch;
}
.exploded > .error {
	background-color: #f97;
	padding: 3px;
	border-radius: 5px;
}
.exploded > .error.first {
	background: #f77;
}
.row.error {
	background: #fcc;
	outline: 3px dashed #d00;
}
.transform {
	background: #fffaf0;
}
footer {
	text-align: center;
	color: #666;
	margin-top: 1rem;
	margin-bottom: 0.5rem;
}
@media only screen and (max-width: 800px) { 
	body {
		margin: 0;
	}
	button {
		font-size: 100%;
	}
	header {
		margin: 1rem 1rem 0 1rem;
	}
	#input, #controls, #options, #examples {
		margin: 0 1rem;
	}
	#content {
		font-size: 12pt;
	}
	a.wide {
		font-size: 95%;
	}
	.row {
		justify-content: center;
	}
	.row.details .wide {
		padding-left: 5px;
		padding-right: 5px;
	}
	.row.details .label {
		flex-direction: column-reverse;
		margin-left: 5px;
	}
	.row.details .script {
		text-align: center;
		margin-left: 0;
		font-size: 80%;
		flex: initial;
	}
	#examples_btn {
		display: block;
		font-size: 150%;
	}
}
</style>
</head>
<body>
<header>
<h1><a href="https://ens.domains/">ENS Resolver</a><span id="provider"></span></h1>
<span id="version"><a href="https://github.com/adraffy/ens-normalize.js">@adraffy/ens-normalize.js</a><br>
<a href="https://github.com/adraffy/ensip-norm">@adraffy/ensip-norm</a></span>
</header>
<div id="examples">
<button>vitalik.eth</button>
<button>nIcK.eTh</button>
<button>brantly.cash</button>
<button>..eth</button>
<button>√∂bb</button>
<button>√ñbb</button>
<button data-name="‚óåÃàbb">‚ùå‚óåÃàbb</button>

<a href="https://adraffy.github.io/punycode.js/test/demo.html"><b>Punycode:</b></a>
<button>‚ùåxn--ls8h</button>
<button>xn--üí©</button>
<button>üí∑pound.eth</button>

<b>Subdomain:</b>
<button data-name="nowzad.loopring.eth">loopring</button>
<button data-name="239.chonksociety.eth">Chonk #239</button>
<button>raffy.antistupid.com</button>

<a href="https://docs.ens.domains/ens-improvement-proposals/ensip-10-wildcard-resolution"><b>Wildcard:</b></a>
<button>1.offchainexample.eth</button>
<button>barmstrong.cb.id</button>

<!--
<a href="./display.html"><b>Display:</b></a>
<button>ADRaffy</button>
-->

<b>Address:</b>
<button data-name="0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045">d8dA..6045</button>

<b>Hyperlink:</b>
<button data-name="https://opensea.io/assets/ethereum/0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85/91842011529764390124322931916134555051359118325819011691525342013207339157209">OpenSea</button>

<a href="./chars.html"><b>Chars</b></a> / <b>Mapped:</b> 
<button data-name="hyph{2D}{2010}{2011}{2012}{2013}{2014}{2015}{2043}{2212}{23AF}{23E4}{FE58}ens">Hyphens</button>
<button>A.‚Ñ¢Ô∏è.–Æ</button>
<button>‚Öß</button>
<button>‚®å</button>

<b>Ignored:</b> 
<button data-name="{FE0E}{FE0F}">Emoji Style</button>

<b>Disallowed:</b>
<button data-name="{26}{3000}{E0061}{FFFFFF}">Types</button>
<button data-name="[ba967c160905ade030f84952644a963994eeaed3881a6b8a4e9c8cbe452ad7a2].eth" data-skip="1">"üí©.eth"</button>

<b>Deviation:</b> 
<button>√ü</button>
<button>œÇ</button>

<b>Complex:</b>
<button data-name="_1{FE0F}E{FE0E}{303}{AD}{1F4A9}{24C2}{FE0E}{2E3B}a{301}"></button>

<b>Combining Marks:</b>
<button data-name="{300}">Leading</button>
<button data-name="x{300}{300}">Adjacent</button>
<button data-name="üí©{300}">Emoji</button>

<b>Whitespace:</b>
<button data-name="test .te st. test">‚ùåInvalid</button>

<b>Stops:</b>
<button>„ÄÇ</button>
<button>Ôºé</button>
<button>ÔΩ°</button>
<button>€î</button>

<a href="https://unicode.org/reports/tr46/#Validity_Criteria"><b>CheckHyphen:</b></a>
<button>-test</button>
<button>test-</button>
<button>‚ùåte--st</button>

<b>Underscore:</b>
<button>__ab</button>
<button>‚ùåa_b</button>

<a href="./emoji.html"><b>Emoji:</b></a>
<button id="random_emoji_btn">üé≤ Random</button>
<button>¬©</button>
<button>üïµ</button>
<button data-name="üí©üí©üí©">üí©<sup>3</sup></button>
<button data-name="üçûüçûüçûüçûüçûüçûüçûüçûüçûüçûüçûüçûüçû">üçû<sup>13</sup></button>
<button data-name="üëÅüó®üëÅÔ∏è‚Äçüó®Ô∏è">üëÅÔ∏è‚Äçüó®Ô∏è</button>
<button data-name="üßüüßü‚ôÇüßü‚Äç‚ôÇ">üßü</button>
<button>üòµ‚Äçüí´üòµ‚Äçüí´üòµ‚Äçüí´</button>
<button>üòµüí´üòµüí´üòµüí´</button>
<button>üë©‚Äç‚öïüë©üèΩ‚Äç‚öïÔ∏è</button>
<button>üë™üë®‚Äçüë©‚Äçüë¶</button>
<button data-name="üö¥Ô∏èüöµÔ∏èüö¥üèªüö¥üèºüö¥üèΩüö¥üèæüö¥üèøüöµüèªüöµüèºüöµüèΩüöµüèæüöµüèøüö¥‚Äç‚ôÄÔ∏èüö¥‚Äç‚ôÇÔ∏èüöµ‚Äç‚ôÄÔ∏èüöµ‚Äç‚ôÇÔ∏èüö¥üèª‚Äç‚ôÄÔ∏èüö¥üèª‚Äç‚ôÇÔ∏èüö¥üèº‚Äç‚ôÄÔ∏èüö¥üèº‚Äç‚ôÇÔ∏èüö¥üèΩ‚Äç‚ôÄÔ∏èüö¥üèΩ‚Äç‚ôÇÔ∏èüö¥üèæ‚Äç‚ôÄÔ∏èüö¥üèæ‚Äç‚ôÇÔ∏èüö¥üèø‚Äç‚ôÄÔ∏èüö¥üèø‚Äç‚ôÇÔ∏èüöµüèª‚Äç‚ôÄÔ∏èüöµüèª‚Äç‚ôÇÔ∏èüöµüèº‚Äç‚ôÄÔ∏èüöµüèº‚Äç‚ôÇÔ∏èüöµüèΩ‚Äç‚ôÄÔ∏èüöµüèΩ‚Äç‚ôÇÔ∏èüöµüèæ‚Äç‚ôÄÔ∏èüöµüèæ‚Äç‚ôÇÔ∏èüöµüèø‚Äç‚ôÄÔ∏èüöµüèø‚Äç‚ôÇÔ∏è">üö¥Ô∏è Bikes (36)</button>
<button data-name="ü¶∞ü¶±ü¶≤ü¶≥">ü¶∞</button>
<button>‚ùåüë®‚Äçüë©‚Äçüë¶üèø</button>
<button data-name="{1F3FB}{1F3FC}{1F3FD}{1F3FE}{1F3FF}">‚ùåüèª</button>
<button data-name="üí©{200D}üí©">‚ùåüí©+üí©</button>
<button>‚ùå‚ÄºÔ∏è</button>
<button>‚ùå‚ÅâÔ∏è</button>
<button data-name="‚Ñ¢‚Ñπ‚ìÇ„äó„äôüàÅüàÇüàöüàØüà≤üà≥üà¥üàµüà∂üà∑üà∏üàπüà∫üâêüâë">‚òπÔ∏è Demoted</button>

<b>Non-RGI:</b>
<button>üê±‚Äçüêâ</button>
<button>üë™üèª</button>
<button>ü§ºüèª‚Äç‚ôÄÔ∏è</button>
<button data-name="{1F469}{1F3FE}{200D}{1F91D}{200D}{1F469}{1F3FE}">Mod+Mod</button>

<b>Regional:</b>
<button>‚ùåüá¶</button>
<button>‚ùåüá¶üá¶</button>
<button>üá∫üá∏üá∫üá≤</button>

<b>Flag:</b>
<button>üè¥</button>
<button>üèÅÔ∏è</button>
<button>üè≥Ô∏è‚Äçüåà</button>

<a href="https://www.unicode.org/reports/tr51/#DisplayValidEmojiTagSeqs"><b>Tag:</b></a>
<button>{1F3F4}{E0067}{E0062}{E0065}{E006E}{E0067}{E007F}</button>
<button>{1F3F4}{E0067}{E0062}{E0073}{E0063}{E0074}{E007F}</button>
<button>{1F3F4}{E0067}{E0062}{E0077}{E006C}{E0073}{E007F}</button>
<button data-name="{1F3F4}{E0075}{E0073}{E0063}{E0061}{E007F}">‚ùåusca</button>

<b>Circled/Squared:</b>
<button>i{2139}{2139}{FE0F}üõà</button>
<button data-name="‚í∂‚í∑‚í∏‚íπ‚í∫‚íª‚íº‚íΩ‚íæ‚íø‚ìÄ‚ìÅ‚ìÇ‚ìÉ‚ìÑ‚ìÖ‚ìÜ‚ìá‚ìà‚ìâ‚ìä‚ìã‚ìå‚ìç‚ìé‚ìè">‚í∂-‚ìè</button>
<button data-name="üÖêüÖëüÖíüÖìüÖîüÖïüÖñüÖóüÖòüÖôüÖöüÖõüÖúüÖùüÖûüÖüüÖ†üÖ°üÖ¢üÖ£üÖ§üÖ•üÖ¶üÖßüÖ®üÖ©">üÖê-üÖ©</button>
<button data-name="üÖ∞üÖ±üÖ≤üÖ≥üÖ¥üÖµüÖ∂üÖ∑üÖ∏üÖπüÖ∫üÖªüÖºüÖΩüÖæüÖøüÜÄüÜÅüÜÇüÜÉüÜÑüÜÖüÜÜüÜáüÜàüÜâ">üÖ∞-üÜâ</button>
<button data-name="‚ìø‚ù∂‚ù∑‚ù∏‚ùπ‚ù∫‚ùª‚ùº‚ùΩ‚ùæ‚ùø">‚ìø-‚ùø</button>
<button data-name="üÑå‚ûä‚ûã‚ûå‚ûç‚ûé‚ûè‚ûê‚ûë‚ûí‚ûì">üÑå-‚ûì</button>
<button data-name="„âà„ââ„âä„âã„âå„âç„âé„âè">„âà-„âè</button>

<a href="https://datatracker.ietf.org/doc/html/rfc5892#appendix-A.1"><b>ContextJ:</b></a>
ZWNJ:
<button data-name="‡¥®‡µç{200C}‡¥Æ"></button>
<button data-name="ŸÜ€åŸÖ‚ÄåŸÅÿßÿµŸÑŸá"></button>
<button data-name="a{200C}b"></button>

ZWJ:
<button data-name="‡¥£‡µç‚Äç"></button>
<button data-name="a{200D}b"></button>

<a href="https://datatracker.ietf.org/doc/html/rfc5892#appendix-A.3"><b>ContextO:</b></a>
Middle Dot: 
<button data-name="{6C}{B7}{6C}"></button>

Katakana Dot:
<button data-name="Êúà„ÉªÊ∞¥"></button>
<button data-name="a„Éªa{300}"></button>

Greek Keraia: 
<button data-name="{375}Œ±"></button>

Hebrew Geresh:
<button data-name="{5D1}{5F3}"></button>


<a href="https://www.rfc-editor.org/rfc/rfc5893.html#section-2"><b>CheckBidi:</b></a>
<button>◊§◊¢◊ô◊ú◊ï◊™◊î◊ë◊ô◊†◊ê◊ï◊ù</button>
<button data-name="{0786}{07AE}{0782}{07B0}{0795}{07A9}{0793}{07A6}{0783}{07AA}">Dhivehi</button>
<button data-name="{05D9}{05B4}{05D5}{05D0}{05B8}">Yiddish</button>
<button data-name="{1F1F8}{1F1E6}{633}{644}{645}{627}{646}">Emoji+RTL</button>
<button data-name="{633}{644}{645}{627}{646}{1F1F8}{1F1E6}">RTL+Emoji</button>
<button data-name="bahrain.ŸÖÿµÿ±">LTR.RTL</button>
<button data-name="bahrainŸÖÿµÿ±">‚ùåLTR+RTL in Label</button>
<button data-name="{202e}elgoog{202d}.eth">‚ùå.ethgoogle</button>
<button data-name="{202e}hte.elgoog">‚ùågoogle.eth</button>

<b>Keycaps:</b>
<button>1‚É£2Ô∏è‚É£üîü.eth</button>
<button data-name="0Ô∏è‚É£1Ô∏è‚É£2Ô∏è‚É£3Ô∏è‚É£4Ô∏è‚É£5Ô∏è‚É£6Ô∏è‚É£7Ô∏è‚É£8Ô∏è‚É£9Ô∏è‚É£üîü*Ô∏è‚É£#Ô∏è‚É£">*Ô∏è‚É£-üîü</button>

<a href="https://unicode-org.github.io/cldr-staging/charts/latest/by_type/core_data.alphabetic_information.main.html">Exemplars</a> /
<a href="https://util.unicode.org/UnicodeJsps/confusables.jsp">Confusables</a> /
<a href="./confused.html"><b>Confused:</b></a>
<button>aŒ±.…ë</button>
<button>‡Æ∂‡Øç‡Æ∞‡ØÄ.‡Æ∏‡Øç‡Æ∞‡ØÄ</button>
<button data-name="i.iÃá.ƒ±Ãá">iÃá</button>
<button data-name="√®.eÃÄ.—ê.–µÃÄ">√®</button>

<b>Mixed-Script:</b>
<button data-name="0a„Äá.Èªëa8">Digit+Latin+Han</button>
<button data-name="„ÅÇ„Ç¢„ÅÑ„Ç§„ÅÜ„Ç¶„Åà„Ç®„Åä„Ç™">Kana+Hira</button>
<button data-name="bitcoin.bitcŒøin.biÃátcoin.bit—Åoin">"bitcoin"</button>
<button>‚ùå„Ç°Ìû£</button>

<b>Whole-Script:</b>
<button data-name="0x.0œá.0—Ö">"0x"</button>
<button data-name="apple.–¥—Ä—Ä”è–µ.–∞—Ä—Ä”è–µ.a—Ä—Ä”è–µ">"apple"</button>
<button data-name="ŒπŒøœÉœÅŒ≤œÖŒΩŒ≥">‚ùåGreek</button>
<button data-name="o.Ÿ•.‡•¶.‡±¶.‡©¶.‡µ¶.Œø.÷Ö">"o"</button>
<button data-name="„ÅÇ„Éº.„Äá‰∏Ä.‰∏Ä„Éº.‰∏Ä.„Éº.·Ö≥">CJK Dash</button>

<a href="https://unicode.org/emoji/charts/emoji-released.html"><b>Unicode 15:</b></a>
<button data-name="{1F6DC}{1FA75}{1FA76}{1FA77}{1FA87}{1FA88}{1FAAD}{1FAAE}{1FAAF}{1FABB}{1FABC}{1FABD}{1FABF}{1FACE}{1FACF}{1FADA}{1FADB}{1FAE8}{1FAF7}{1FAF8}">Single Emoji (20)</button>
<button data-name="{1FAF7}{1F3FB}{1FAF7}{1F3FC}{1FAF7}{1F3FD}{1FAF7}{1F3FE}{1FAF7}{1F3FF}{1FAF8}{1F3FB}{1FAF8}{1F3FC}{1FAF8}{1F3FD}{1FAF8}{1F3FE}{1FAF8}{1F3FF}">Sequences (10)</button>
<button data-name="{1F426}{200D}{2B1B}">Black Bird</button>

<b>Fenced:</b>
<button>O'Brian</button>
<button data-name="¬º¬Ω¬æ‚Öê‚Öë‚Öí‚Öì‚Öî‚Öï‚Öñ‚Öó‚Öò‚Öô‚Öö‚Öõ‚Öú‚Öù‚Öû‚Öü‚Üâ">"¬Ω"</button>
<button>123‚ÅÑ456‚Äôs</button>
<button data-name="a'.‚Äôz.a'‚Äôb.a‚ÅÑ'.‚ÅÑa">‚ùåInvalid</button>

<b>Misc:</b>
<button data-name="$¬¢¬£¬§¬•‚Ç°‚Ç¶‚Ç©‚Ç™‚Ç´‚Ç¨‚Ç≠‚ÇÆ‚Ç±‚Ç≤‚Ç¥‚Çµ‚Ç∏‚Çπ‚Ç∫‚Çº‚ÇΩ‚Çæ‚ÉÄ‚ÇøŒû.ÿã">Currency</button>
<button data-name="‚Ä¢-‚Ä¢¬¨.‚åê‚ó®-‚ó®.‚åê„Äá-„Äá¬¨">Glasses</button>
<button>360¬∞</button>
<button data-name="2œÄr.4œÄŒ∏.8–ø">"œÄ"</button>
<button>Œû.‚â°.‚ò∞</button>
<button>‚ô¢‚ü†‚ß´</button>

<button data-name="·¥Ä ô·¥Ñ·¥Ö·¥áÍú∞…¢ ú…™·¥ä·¥ã ü·¥ç…¥·¥è·¥òÍûØ ÄÍú±·¥õ·¥ú·¥†·¥°x è·¥¢">‚ùåÍú±·¥ç·¥Ä ü ü ·¥Ñ·¥Ä·¥òÍú±</button>
<button data-name="z éx ç ån ás…πbdou…ØÍûÅ û≈øÃ£·¥â…•·µ∑…ü«ùp‚ÜÑq…ê">‚ùåp«ùu…πn á</button>

<b>Pure:</b>
Arabic:
<button>ÿ•ŸÜÿ™ÿ±ŸÜÿ™</button>
<button data-name="{660}{661}{662}{663}{664}{665}{666}{667}{668}{669}.{6F0}{6F1}{6F2}{6F3}{6F4}{6F5}{6F6}{6F7}{6F8}{6F9}.{6F0}{780}">Digits</button>
Hebrew:
<button>◊©◊ô◊®◊ï◊™÷æ◊©◊û◊ï◊™</button>

<a href="https://www.unicode.org/reports/tr31/#Table_Candidate_Characters_for_Exclusion_from_Identifiers"><b>Restricted:</b></a>
<button data-name="ìÄÄìÄÅìÄÇ">Egyptian Hieroglyphs</button>
<button data-name="êå±êåªêçâêåºêå∞">Gothic</button>
<button>ìÜè‚û°üê∏Ô∏è</button>
<button data-name="aìÄÇ">‚ùåMixed</button>
<button>‚ùå·èé·èÆ·èÇ·é•.eth</button>

</div>
<div id="options">
<label><input type="checkbox" id="auto_resolve_check" checked>Resolve on Input</label>
<label><input type="checkbox" id="show_details_check" checked>Details</label>
<label><input type="checkbox" id="show_components_check" checked>Emoji Components</label>
<span><input type="checkbox" id="skip_norm_check"><label class="nonstd" for="skip_norm_check">Skip Normalization</label></span>
</div>
<div id="input">
<label for="input_field">Name or Address:</label>
<input id="input_field" size="20" placeholder="Name or Address (Checksummed) or OpenSea URL">
</div>
<div id="controls">
<div id="arrows" class="hide"><div class="arrows"></div></div>
<div class="balloon"></div>
<button id="nf_btn">NFD‚ÜîNFC</button>
<button id="escape_btn">Escape</button>
<button id="link_btn">Copy Link</button>
<button id="resolve_btn">Resolve</button>
</div>
<div id="output">
<ul class="row readme">
<li>Click an <button data-name="üëÅÔ∏è‚Äçüó®Ô∏èA{303}">Example</button> to see how it works.</li>
<li>Use <code>{FF}</code> or <code>[255]</code> to manually include codepoints, eg. <button data-escape data-name="a{200D}b.eth">ZWJ</button></li>
<li>Input <code>"0123 4567 89AB CDEF"</code> to interpret as hex codepoints.</li>
<li><a href="#vitalik.eth"><b>Copy Link</b></a> to get a URL that resolves on page-load.</li>
</ul>
<ul class="row legend">
<li>This is a <b>valid</b> sequence of characters: <div data-tokenize="abc"></div> and <b>.eth</b> name: <div data-tokenize="abc.eth"></div></li>
<li>This is an <b>emoji</b>: <div data-tokenize="üë©üèΩ‚Äç‚öïÔ∏è"></div> and its corresponding <b>components</b>: <div data-tokenize="üë©üèΩ‚Äç‚öïÔ∏è" data-parts="1"></div></li>
<li>This is a <b>mapped</b> token: <div data-tokenize="‚Ñ¢"></div> which transforms into a <b>valid</b> sequence: <div data-tokenize="tm"></div></li>
<li>Characters not in canonical form require <b>NFC</b>: <div data-tokenize="a{303}"></div></li>
<li>This is an <b>ignored</b> character: <div data-tokenize="{FE0F}"></div></li>
<li>These are <b>disallowed</b> characters: <div data-tokenize="#{00}{1FFFFF}{E0061}{200D}"></div></li>
</ul>
<ul class="row links">
<li><a href="./emoji.html">Find Supported Emoji</a></li>
<li><a href="./chars.html">Browse Supported Characters</a></li>
<li><a href="./confused.html">Confused</a>
<li><a href="https://adraffy.github.io/punycode.js/test/demo.html">Punycode Coder</a></li>
<li><a href="https://adraffy.github.io/keccak.js/test/demo.html">Keccak Hasher</a></li>
<li><a href="https://raffy.antistupid.com/eth/ens-regs.html">Recent ENS Registrations</a></li>
<li><a href="https://raffy.antistupid.com/eth/emoji-pixels.html">Emoji Pixel Maker</a></li>
</ul>
</div>
<footer>Created by <a href="https://twitter.com/adraffy">raffy.eth</a></footer>
<script type="module">
import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.1/ethers.esm.min.js";
import {
	ens_normalize, ens_split, ens_beautify, ens_tokenize, ens_emoji,
	nfc, nfd, hex_cp, explode_cp, safe_str_from_cps,
	dom_from_tokens, use_default_style
} from '../dist/all.min.js';
import {puny_encoded} from '../../punycode.js/dist/index.min.js';
use_default_style();

let infura_provider = new ethers.providers.WebSocketProvider('wss://mainnet.infura.io/ws/v3/f36f6a8638134ac09f9400d3a7008dfe');
let active_provider = infura_provider;
let window_provider;
let registry_contract;
let eth_nft_contract;
let price_oracle_contract;
//let eth_controller_contract;

const EMOJI = ens_emoji();

const input_field = document.querySelector('#input_field');
const resolve_btn = document.querySelector('#resolve_btn');
const primary_arrows = document.querySelector('#arrows');
const auto_resolve_check = document.querySelector('#auto_resolve_check');
const show_components_check = document.querySelector('#show_components_check');
const skip_norm_check = document.querySelector('#skip_norm_check');
const show_details_check = document.querySelector('#show_details_check');
const options_div = document.querySelector('#options');
const controls_div = document.querySelector('#controls');
const output_div = document.querySelector('#output');
const readme_dom = [...output_div.childNodes]; // save initial ux
const examples_div = document.querySelector('#examples');
const examples_btn = document.createElement('button');
examples_btn.id = 'examples_btn';

const RESOLVE_MODE_IDLE = 'idle';
const RESOLVE_MODE_REPEAT = 'repeat';
const RESOLVE_MODE_EMPTY = 'empty';

const INPUT_NAME = 'Input';
const OPENSEA_NAME = 'OpenSea';
const SKIP_SUFFIX = '_!';
const PRETTY_NAME = 'üíñÔ∏è'; // üå∑Ô∏è üå∫Ô∏è

const emoji_url = './emoji.html#q=%s';

const ENS_REGISTRY = '0x00000000000C2E074eC69A0dFb2997BA6C7d2e1e';
const ENS_NFT = '0x57f1887a8BF19b14fC0dF6Fd9B2acc9Af147eA85';

let resolve_timer = RESOLVE_MODE_IDLE;
let resolve_options;
let resolve_date0;

// TODO: add more
// this might require too much extra information
const DIGIT_MAP = new Map();
function add_digits(name, digits, extra = {}) {
	explode_cp(digits).forEach((cp, i) => DIGIT_MAP.set(cp, {name, i, ...extra}));
}
add_digits('ASCII', '0123456789');
add_digits('Arabic', 'Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©', {mixed: 1}); //, reversed: true
[[0x6F4, 4], [0x6F5, 5], [0x6F6, 6]].forEach(([cp, i]) => {
	DIGIT_MAP.set(cp, {name: 'Extended Arabic', i, mixed: 1});
});
add_digits('Simplified CJK', '„Äá‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πù');
add_digits('Devangari', '‡•¶‡•ß‡•®‡•©‡•™‡•´‡•¨‡•≠‡•Æ‡•Ø');
//add_digits('Thai', '‡πê‡πë‡πí‡πì‡πî‡πï‡πñ‡πó‡πò‡πô');
//add_digits('Myanmar', '·Çê·Çë·Çí·Çì·Çî·Çï·Çñ·Çó·Çò·Çô');

read_local_storage('hide_examples',   x => examples_div.classList.toggle('hide', x));
read_local_storage('show_details',    x => show_details_check.checked = x);
read_local_storage('auto_resolve',    x => auto_resolve_check.checked = x);
read_local_storage('show_components', x => show_components_check.checked = x);

for (let btn of document.querySelectorAll('#examples button:not([id]), button[data-name]')) {
	let name = btn.innerText;
	if (btn.dataset.name) {
		name = btn.dataset.name;
	} else if (name.startsWith('‚ùå')) {
		name = [...name].slice(1).join('');
	}
	name = replace_escapes(name);
	if (!btn.innerText || btn.innerText.includes('{')) btn.innerText = name;
	if (!name.includes('.') && !is_checksum_address(name)) name += '.eth';
	if (typeof btn.dataset.escape === 'string') name = apply_escapes(name, false);
	if (!btn.title) btn.title = `${name}\n${explode_cp(name).map(hex_cp).join(' ')}`;
	btn.addEventListener('click', () => {
		input_field.value = name;
		if (btn.dataset.skip) skip_norm_check.checked = true;
		if (options_div.getBoundingClientRect().top > window.innerHeight * .9) {
			options_div.scrollIntoView(); // scuffed
		}
		resolve();
	});
}
for (let div of document.querySelectorAll('[data-tokenize]')) {
	div.replaceWith(dom_from_tokens(ens_tokenize(replace_escapes(div.dataset.tokenize)), {
		emoji_url,
		components: div.dataset.parts
	}));
}

resolve_btn.addEventListener('click', () => resolve());
input_field.addEventListener('keydown', e => {
	if (e.key === 'Enter') {
		e.stopPropagation();
		resolve();
	}
});
input_field.addEventListener('input', () => {
	if (parse()) {
		schedule_resolve(500);
	}
});

document.querySelector('#random_emoji_btn').addEventListener('click', () => {
	let name = '';
	while ([...name].length < 3) {
		name += ens_normalize(String.fromCodePoint(...EMOJI[Math.random() * EMOJI.length|0]));
	}
	input_field.value = `${name}.eth`;
	skip_norm_check.checked = false;
	resolve();
});

document.querySelector('#nf_btn').addEventListener('click', () => {
	let s0 = input_field.value;
	let s1 = replace_escapes(s0);
	let s2 = apply_escapes(String.fromCodePoint(...nfd(explode_cp(s1))));
	let s3 = apply_escapes(String.fromCodePoint(...nfc(explode_cp(s1))));
	let s4 = s0 == s2 ? s3 : s2;
	if (s0 != s4) {
		input_field.value = s4;
		resolve();
	}
});

document.querySelector('#escape_btn').addEventListener('click', () => {
	let s0 = input_field.value;
	let s1 = replace_escapes(s0);
	let s2 = apply_escapes(s1);
	let s3 = apply_escapes(s1, true);
	let set = [...new Set([s1, s2, s3])];
	let pos = set.indexOf(s0);	
	input_field.value = set[(pos + 1) % set.length];
});

document.querySelector('#link_btn').addEventListener('click', () => {
	let hash = '#' + encodeURIComponent(input_field.value);
	if (skip_norm_check.checked) hash += SKIP_SUFFIX;
	navigator.clipboard.writeText(window.location.href.split('#')[0] + hash);
});

auto_resolve_check.addEventListener('input', () => {
	window.localStorage.setItem('auto_resolve', !!auto_resolve_check.checked);	
	resolve_if_auto();
});
show_details_check.addEventListener('input', () => {	
	window.localStorage.setItem('show_details', !!show_details_check.checked);	
	for (let el of document.querySelectorAll('.detailed')) {
		el.classList.toggle('hide', !show_details_check.checked);
	}
});
show_components_check.addEventListener('input', () => {
	window.localStorage.setItem('show_components', !!show_details_check.checked);
	update_exploded();
});
skip_norm_check.addEventListener('input', resolve_if_auto);
examples_btn.addEventListener('click', () => {
	examples_div.classList.toggle('hide');
	window.localStorage.setItem('hide_examples', !!examples_div.classList.contains('hide'));
	update_examples();
});

if (window.ethereum) {
	window_provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
	window_provider.on('network', update_network);
} else {
	update_network();
}

update_examples();
input_field.focus();
apply_location_hash();
window.addEventListener('hashchange', apply_location_hash);

function update_network(network) {
	let registry;
	let provider_name;
	let network_name;
	if (network && network.ensAddress) {
		active_provider = window_provider;
		provider_name = `window.ethereum`;
		network_name = network.name.replace('homestead', 'mainnet');
		registry = network.ensAddress;
	} else {
		active_provider = infura_provider;
		provider_name = 'Infura';
		network_name = 'mainnet';
		registry = ENS_REGISTRY;
	}
	document.querySelector('#provider').innerHTML = `using ${provider_name} (<b>${network_name}</b>)`;
	registry_contract = new ethers.Contract(registry, [
		`function resolver(bytes32 node) external view returns (address)`,
		`function owner(bytes32 node) external view returns (address)`,
	], active_provider);
	eth_nft_contract = null;
	if (input_field.value) {
		schedule_resolve(250);
	}
}

function update_examples() {
	if (examples_div.classList.contains('hide')) {
		examples_btn.innerHTML = 'üëÄ Show Examples';
		options_div.prepend(examples_btn);
	} else {
		examples_btn.innerHTML = 'üôà <b>Hide Examples</b>';
		examples_div.prepend(examples_btn);
	}
}

function apply_location_hash() {
	let name = decodeURIComponent(window.location.hash.slice(1));
	let skip = name.endsWith(SKIP_SUFFIX);
	if (skip) name = name.slice(0, -SKIP_SUFFIX.length);
	skip_norm_check.checked = skip;
	input_field.value = name;
	resolve();
}

function should_stop_resolving() {
	return resolve_timer !== RESOLVE_MODE_IDLE;
}

function schedule_resolve(delay) {
	if (!auto_resolve_check.checked) return;
	resolve_options = {
		automatic: true,
		skip_norm: skip_norm_check.checked
	};
	if (is_working()) {
		clearTimeout(resolve_timer);
		resolve_timer = RESOLVE_MODE_REPEAT;
	} else { //if (!should_stop_resolving()) {
		primary_arrows.classList.remove('hide');
		clearTimeout(resolve_timer);
		resolve_timer = setTimeout(() => resolve(resolve_options), delay);
	}
} 

function resolve_if_auto() {
	if (auto_resolve_check.checked && input_field.value) {
		if (parse()) resolve();
	}
}

function stop_resolving() {
	clearTimeout(resolve_timer);
	resolve_timer = RESOLVE_MODE_EMPTY;
	primary_arrows.classList.add('hide');
}

function parse() {
	output_div.innerHTML = '';
	let name = replace_escapes(input_field.value);
	controls_div.classList.toggle('hide', !name);
	if (!name) {
		stop_resolving();
		output_div.append(...readme_dom);
		return;
	}
	if (resolve_timer === RESOLVE_MODE_EMPTY) {
		resolve_timer = RESOLVE_MODE_IDLE;
	}
	if (is_checksum_address(name)) {
		let row = create_row('Address');
		row.append(create_etherscan_address_link(name));		
		add_row_tag(row, create_reverse_resolve_btn(name));
		output_div.append(row);
		return true;
	}
	let row = create_row(INPUT_NAME);
	make_exploded(row, name, false);
	output_div.append(row, create_details_row(name, true));
	try {
		let norm = ens_normalize(name);
		if (norm === name) {
			make_normalized(row);
		} else {
			add_row_tag(row, create_typed_tag('fail', 'Normalized'));
			if (!skip_norm_check.checked) {
				add_transformed_row(name);
				let norm_row = create_row('Normalized');
				make_exploded(norm_row, norm, true);
				make_normalized(norm_row);
				output_div.append(norm_row, create_details_row(norm));
			}
		}
		//output_div.append(create_dns_row(norm));
		return true;
	} catch (err) {
		row.classList.add('error');
		add_row_tag(row, create_typed_tag('warn', err));
		if (skip_norm_check.checked) return true;
		stop_resolving();
		let tokens = ens_tokenize(name).flatMap(token => token.type === 'nfc' ? token.tokens : token);
		if (tokens.some(x => x.type === 'disallowed')) {

			let stripped = name.replace(/\s+/g, '');
			if (stripped !== name) {
				let strip_btn = document.createElement('button');
				strip_btn.innerHTML = 'Strip Whitespace';
				strip_btn.addEventListener('click', () => {
					input_field.value = stripped;
					resolve();
				});
				add_row_tag(row, strip_btn);
			}

			let disallowed_btn = document.createElement('button');
			disallowed_btn.innerHTML = 'Remove Disallowed';
			disallowed_btn.addEventListener('click', () => {
				input_field.value = String.fromCodePoint(...tokens.flatMap(token => {
					switch (token.type) {
						case 'disallowed': return [];
						case 'valid': return token.cps;
						case 'nfc':
						case 'emoji': return token.input;
						default: return token.cp;
					}
				}));
				resolve();
			});
			add_row_tag(row, disallowed_btn);
		}		
	}
}

function add_transformed_row(input) {
	if (ens_tokenize(input).some(x => x.type === 'nfc' || x.type === 'mapped')) {
		let row = create_row('Transformed');
		row.classList.add('transform', 'detailed');
		row.classList.toggle('hide', !show_details_check.checked);
		make_exploded(row, input, true);
		output_div.append(row);
	}
}

function create_dns_row(name) {
	let row = create_row('DNS');
	row.classList.add('dns');
	try {
		const MAX_LABEL = 63;
		const MAX_NAME = 253; 
		const VALID_REGEX = /^[-0-9a-z]*$/;
		let encoded = name.split('.').map(label => {
			let cps = explode_cp(label);
			try {
				let encoded = puny_encoded(cps).toLowerCase();
				if (!VALID_REGEX.test(encoded)) {
					let first = [...encoded].find(ch => !VALID_REGEX.test(ch));
					throw new Error(`unsupported ASCII: "${safe_str_from_cps(explode_cp(first))}"`);
				}
				if (encoded === label) {
					if (label.startsWith('xn--')) throw new Error('punycode literal');
					if (label.slice(2, 4) === '--') throw new Error('invalid label extension');
					if (label.startsWith('-')) throw new Error('leading hyphen');
					if (label.endsWith('-')) throw new Error('trailing hyphen');
				}
				if (encoded.length > MAX_LABEL) throw new Error(`too long: ${encoded.length} > ${MAX_LABEL}`);
				return encoded;
			} catch (err) {
				throw new Error(`Invalid label "${safe_str_from_cps(cps)}": ${err.message}`);
			}
		}).join('.');
		if (encoded.length > MAX_NAME) {
			throw new Error(`Name too long: ${encoded.length} > ${MAX_NAME}`);
		}
		let browser;
		try {
			browser = new URL(`https://${name}`).host;
		} catch (ignored) {
		}
		row.append(create_main_span(encoded));
		add_row_tag(row, create_copy_btn(encoded));
		if (encoded === name) {
			add_row_tag(row, create_typed_tag('good', 'Verbatim'));
		} else if (!browser || browser !== encoded) {
			add_row_tag(row, create_typed_tag('stop', 'Pre-IDNA Punycode Required'));
			if (browser) {
				add_row_tag(row, create_copy_btn(browser, {title: 'Copy Mangled'}));
			}
		} else {
			add_row_tag(row, create_typed_tag('second', 'Punycode Compatible'));
		}
		add_row_tag(row, create_link(`https://${encoded}.limo`, '.limo'));
		add_row_tag(row, create_link(`https://${encoded}.link`, '.link'));
		add_row_tag(row, create_link(`https://${encoded}.xyz`, '.xyz'));
		add_row_tag(row, create_link(`https://adraffy.github.io/punycode.js/test/demo.html#${browser?'p':'u'}=${browser ?? name}`, 'Check'));
	} catch (err) {
		row.classList.add('invalid');
		add_row_tag(row, create_typed_tag('fail', err));
	}
	return row;
}

// if forced, replaced everything
// otherwise, replace non-ascii
function apply_escapes(s, forced) {
	return [...s].map(x => !forced && /^[\x21-\x7E]+$/gu.test(x) ? x : `{${hex_cp(x.codePointAt(0))}}`).join('');
}

function replace_escapes(s) {
	// match: {HEX}, [0xHEX], [DEC]
	return s.replace(/(?:(?:\{([0-9a-f]+)\})|(?:\[((?:0x[0-9a-f]+)|[0-9]+)\]))/uig, (_, a, b, c) => {
		try {
			return String.fromCodePoint(a ? parseInt(a, 16) : parseInt(b)); 
		} catch (err) {
			return 'ÔøΩ';
		}
	});
}

function create_link(url, s, cls) {
	let a = document.createElement('a');
	a.href = url;
	a.innerHTML = s ?? url;
	if (cls) a.classList.add(cls);
	if (!url.includes('ens.domains/') && !url.includes('adraffy.github.io/') && !url.includes('etherscan.io/')) {
		a.classList.add('third-party');
	}
	try {
		new URL(url);
	} catch (err) {
		a.classList.add('invalid');
	}
	return a;
}
function create_ens_link(s, {title = 'ENS'} = {}) {
	return create_link(`https://app.ens.domains/name/${encodeURIComponent(s)}`, title, 'ens');
}
function create_etherscan_address_link(addr, {title, contract} = {}) {
	return create_link(`https://etherscan.io/address/${addr}${contract ? '#readContract' : ''}`, title ?? addr, title ? false : 'wide');
}

function create_copy_btn(s, {title = 'Copy', explode} = {}) {
	let btn = document.createElement('button');
	btn.addEventListener('click', () => navigator.clipboard.writeText(s));
	btn.classList.add('copy');
	btn.innerHTML = title;
	btn.title = s;
	if (explode === undefined) {
		explode = !/^0x[0-9a-f]*$/i.test(s);
	}
	if (explode) {
		btn.title += '\n' + explode_cp(s).map(hex_cp).join(' ');
	}
	return btn;
}

function create_reverse_resolve_btn(addr) {
	return create_resolve_btn(`${addr.slice(2).toLowerCase()}.addr.reverse`, 'Reverse Record');
}
function create_resolve_btn(s, title = 'Resolve') {
	let btn = document.createElement('button');
	btn.innerHTML = title;
	btn.title = s;
	btn.addEventListener('click', () => {
		input_field.value = s;
		resolve();
	});
	return btn;
}

function create_length_span(n, unit = 'ch') {
	let span = document.createElement('span');
	span.classList.add('length');
	span.innerHTML = `${n}<sub>${unit}</sub>`;
	return span;
}

function create_main_span(text) {
	let inner = document.createElement('span');
	inner.classList.add('main', 'long');
	inner.innerText = text;
	let outer = document.createElement('span');
	outer.append(inner);
	return outer;
}

function get_dot_eth_label(name) {
	let v = name.split('.');
	return v.length == 2 && v[1].toLowerCase() == 'eth' ? v[0] : undefined;
}

function create_pretty_tag() {
	let span = document.createElement('span');
	span.classList.add('clean');
	span.innerHTML = PRETTY_NAME;
	span.title = 'Beautified Form';
	return span;
}

function make_normalized(row) {
	row.classList.add('normalized');
	let span = document.createElement('span');
	span.classList.add('clean');
	span.innerHTML = '‚úÖÔ∏è'; 
	span.title = 'Normalized Form';
	add_row_tag(row, span);
}

function create_palindrome_tag() {
	let span = document.createElement('span');
	span.classList.add('palindrome');
	span.innerHTML = '‚áÑ Palindrome';
	return span;
}

function create_ethmoji_row(tokens) {
	let row = create_row('Ethmoji');
	row.classList.add('category');
	let unique = new Set();
	let grouped = [];
	let last;
	for (let token of tokens) {
		let form = String.fromCodePoint(...token.emoji);
		token.form = form; // save
		unique.add(form);
		if (!last || last.form !== form) {
			grouped.push(token);
			token.count = 1;
			last = token;
		} else {
			last.count++;
		}
	}
	let formula = document.createElement('div');
	formula.classList.add('formula');
	formula.innerHTML = grouped.map(token => {
		return `<a href="./emoji.html#q=${String.fromCodePoint(...token.cps)}">${token.form}<sup>${token.count}</sup></a>`;
	}).join('');
	row.append(formula);
	
	let span_grade = document.createElement('span');
	if (tokens.reduce((a, t) => a + t.cps.length, 0) < 3) {
		add_row_tag(row, 'Too Short');

	} else if (tokens.every(t => t.emoji[2] == 0x20E3)) {
		if (tokens.length == 2) {
			add_row_tag(row, create_typed_tag('fire', 'Shortest Keycaps'));
		} else {
			add_row_tag(row, create_typed_tag('second', 'Keycaps'));
		}
	} else if (unique.size == 1) {
		let ncp = last.cps.length;
		if ((ncp == 1 && last.count == 3) || (ncp == 2 && last.count == 2) || (ncp >= 3 && last.count == 1)) {
			add_row_tag(row, create_typed_tag('fire', 'Shortest Repeated'));
		} else {
			add_row_tag(row, create_typed_tag('second', 'Repeated'));
		}
	} else {
		add_row_tag(row, `Unique: ${unique.size}`);
	}

	if (tokens.every((x, i) => x.form == tokens[tokens.length-1-i].form)) {
		add_row_tag(row, create_palindrome_tag());
	}
	return row;
}

function create_digits_row(name, digits, negative) {
	let row = create_row(`${name} Digits`);
	row.classList.add('category');
	let main = document.createElement('span');
	main.innerText = (negative ? '-' : '') + digits.join('');
	row.append(main);
	if (digits.length == (negative ? 2 : 3)) {
		add_row_tag(row, create_typed_tag('fire', 'Shortest'));
	}
	if (digits.every((x, i) => x == digits[0])) {
		add_row_tag(row, create_typed_tag('second', `Repeated (${digits.length})`));
	}
	if (digits.every((x, i) => x == digits[digits.length-1-i])) {
		add_row_tag(row, create_palindrome_tag());
	}
	if (negative) {
		add_row_tag(row, 'Negative');
	}
	if (digits[0] === 0) {
		add_row_tag(row, '0-Pad');
	}
	return row;
}

function add_dot_eth_links(row, name) {
	let label = get_dot_eth_label(name);
	if (!label) return ''; // only if 2LD .eth	
	let hash = labelhash(label);
	add_row_tag(row, create_link(`https://opensea.io/assets/ethereum/${ENS_NFT}/${ethers.BigNumber.from(hash)}`, OPENSEA_NAME));
	add_row_tag(row, create_link(`https://www.ens.vision/name/${encodeURIComponent(label)}`, 'ENS.Vision'));
	add_row_tag(row, create_link(`https://predomain.eth.link/#/domain/${encodeURIComponent(label)}`, 'Predomain'));
	add_row_tag(row, create_link(`https://metadata.ens.domains/mainnet/${ENS_NFT}/${hash}`, 'Metadata', 'ens'));
}

// https://github.com/adraffy/keccak.js/blob/main/src/utils.js#L96
function bytes_from_utf8(s) {
	if (typeof s !== 'string') throw new TypeError('expected string');
	let v = [];
	for (let pos = 0, len = s.length; pos < len; ) {
		let cp = s.codePointAt(pos++);
		if (cp < 0x800) {
			if (cp < 0x80) {
				v.push(cp);
			} else {
				v.push(0xC0 | (cp >> 6), 0x80 | (cp & 0x3F));
			}
		} else {
			if (cp < 0x10000) {
				v.push(0xE0 | (cp >> 12), 0x80 | ((cp >> 6) & 0x3F), 0x80 | (cp & 0x3F));
			} else {
				v.push(0xF0 | (cp >> 18), 0x80 | ((cp >> 12) & 0x3F), 0x80 | ((cp >> 6) & 0x3F), 0x80 | (cp & 0x3F));
				pos++;
			}
		}
	}
	return Uint8Array.from(v);
}

function make_tokens_div(name, before) {
	// tokenize each label separately so we can show major/minor errors
	// flatten non-errors tokens into wrapper	
	let split = ens_split(name);
	let wrapper = document.createElement('div');
	wrapper.classList.add('tokens');
	let first = true;
	for (let i = 0; i < split.length; i++) {
		if (i > 0) {
			wrapper.append(...dom_from_tokens(ens_tokenize('.')).children);
		}
		let {input, error} = split[i];
		let tokens = dom_from_tokens(ens_tokenize(String.fromCodePoint(...input)), {
			before, 
			emoji_url,
			components: show_components_check.checked
		});
		if (error) {
			tokens.classList.add('error');
			if (first) {
				tokens.classList.add('first');
				first = false;
			}
			wrapper.append(tokens);
		} else {
			wrapper.append(...tokens.children);
		}		
	}
	wrapper.classList.add('exploded');
	wrapper.dataset.name = name;
	if (before) wrapper.dataset.before = 1;
	return wrapper;
}

function update_exploded() {
	for (let exploded of output_div.querySelectorAll('.exploded')) {
		let tokens_div = make_tokens_div(exploded.dataset.name, exploded.dataset.before);
		if (exploded.dataset.downgraded) {
			apply_downgrade(tokens_div);
		}
		exploded.replaceWith(tokens_div);
	}
}

function apply_downgrade(tokens_div) {
	tokens_div.dataset.downgraded = '1';
	for (let x of tokens_div.querySelectorAll('.disallowed')) {
		x.classList.add('ignored');
		x.classList.remove('disallowed');
	}
}

function make_exploded(row, name, is_norm, downgrade_disallowed) {	
	let before = !is_norm;
	let tokens_div = make_tokens_div(name, before);
	if (downgrade_disallowed) {
		apply_downgrade(tokens_div);
	}
	row.append(tokens_div);
}

function create_typed_tag(type, desc) {
	let span = document.createElement('span');
	if (desc instanceof Error) {
		span.classList.add('long');
		desc = desc.message;
	}
	switch (type) {
		case 'second': 
			desc = `‚≠êÔ∏è ${desc}`;
			break;
		case 'warn': 
			desc = `‚ö†Ô∏è ${desc}`;
			break;
		case 'fire':
			desc = `üî•Ô∏è ${desc}`;
			break;
		case 'good': 
			break;
		case 'special':
			break;
		case 'fail': 
			desc = `‚ùå ${desc}`;
			break;
		case 'stop':
			type = 'fail';
			desc = `üõë ${desc}`;
			break;
		//default: throw new TypeError(`unknown grade: ${type}`);
	}
	span.innerText = desc;
	span.classList.add(type);
	return span;
}

function create_details_row(name, before) {
	let eth_label = get_dot_eth_label(name);

	let row = create_row();
	row.classList.add('details', 'detailed');
	row.classList.toggle('hide', !show_details_check.checked);

	let hash_span = document.createElement('span');
	hash_span.classList.add('wide');
	hash_span.innerHTML = `<a class="namehash" href="https://adraffy.github.io/keccak.js/test/demo.html#algo=namehash&s=${encodeURIComponent(name)}">Namehash:</a> <code>${namehash(name)}</code>`;
	row.append(hash_span);

	let split = ens_split(name);
	for (let info of split) {

		let cps = before || !info.output ? info.input : info.output;
		let label = String.fromCodePoint(...cps);
		let bytes = bytes_from_utf8(label);
		let hash = labelhash(label);

		let label_div = document.createElement('span');
		label_div.classList.add('label');
		if (info.error) {
			label_div.classList.add('error');
		}
		label_div.innerHTML = `<span class="script">${info.type || ''}</span>`;
		let span_label = document.createElement('span');
		span_label.classList.add('text', 'long');
		label_div.append(span_label);

		let code = document.createElement('code');
		if (cps.length) {
			span_label.innerText = label; // this will <br> CR LF, disabled with css
			let swap_btn = document.createElement('button');
			swap_btn.innerText = `‚áÑ`;
			swap_btn.title = `Swap Codepoints/Bytes`;
			swap_btn.addEventListener('click', update_code);
			function update_code() {
				let {mode} = code.dataset;
				let text;
				if (code.dataset.mode !== 'cp') {
					code.dataset.mode = 'cp';
					code.title = 'Unicode Codepoints';
					text = cps.map(hex_cp).join(' ');
				} else {
					code.dataset.mode = 'byte';
					code.title = 'Encoded UTF-8 Bytes';
					text = [...bytes].map(hex_cp).join(' ');
				}
				code.innerText = text + ' ';
				code.append(swap_btn);
			}
			update_code();
			if (cps.every(cp => cp < 0x80)) {
				swap_btn.remove();
			}
		} else {
			span_label.innerText = '¬´null¬ª';
			span_label.classList.add('disabled');
		}

		let footer = [`<b>Labelhash:</b> <code>${hash}</code>`];
		if (label === eth_label) {
			footer.push(`<b>Token:</b> <code>${ethers.BigNumber.from(labelhash(eth_label))}</code>`);
		}
		//if (info.script) {
		//	footer.unshift(`<span class="script">${info.script}</span>`);
		//}
		if (info.error) { 
			footer.unshift(`<span class="error">‚ö†Ô∏è ${info.error}</span>`);
		}

		let footer_span = document.createElement('span');
		footer_span.classList.add('wide', 'footer');
		footer_span.innerHTML = footer.join('<br>');

		row.append(label_div, create_length_span(cps.length), code, footer_span);
	}
	return row;
}

function create_row(label, waiting) {
	let row = document.createElement('div');
	row.classList.add('row');
	if (label) {
		let span = document.createElement('span');
		span.classList.add('row-label');
		span.innerHTML = `${label}:`;
		row.append(span);
	}
	if (waiting) {
		let div = document.createElement('div');
		div.classList.add('temporary');
		div.innerHTML = '<div class="arrows"></div>';
		row.append(div);
	}
	return row;
}

function remove_temporary(row) {
	for (let x of row.querySelectorAll('.temporary')) {
		x.remove();
	}
}

function add_row_tag(row, tag) {
	if (!tag) return;
	if (typeof tag === 'string') {
		let span = document.createElement('span');
		span.innerHTML = tag;
		tag = span;
	}
	tag.classList.add('tags');
	row.append(tag);
	return true;
}

function trim_trailing_decimal_zeros(s) {
	let match = s.match(/^(.*)\.0+$/);
	if (match) return match[1];
	return s;
}
function format_dur(t) {
	if (t < 1000) return `${Math.ceil(t)}ms`;
	t /= 1000;
	let unit;
	if (t < 60) {
		unit = 's';
	} else {
		t /= 60;
		if (t < 60) {
			unit = 'm';
		} else {
			t /= 60;
			if (t < 24) {
				unit = 'h';
			} else {
				t /= 24;
				if (t < 365) {
					unit = 'd';
				} else {
					t /= 365;
					unit = 'y';
				}
			}
		}
	}
	return trim_trailing_decimal_zeros(t.toFixed(1)) + unit;
}

function is_working() {
	return resolve_btn.disabled;
}

function resolve(options) {
	if (!options) {
		options =  {
			skip_norm: skip_norm_check.checked
		};
	}
	if (is_working()) {
		resolve_timer = RESOLVE_MODE_REPEAT; 
		resolve_options = options;
		return;
	}
	clearTimeout(resolve_timer);
	resolve_timer = RESOLVE_MODE_IDLE;
	let input = input_field.value;
	try {
		let url = new URL(input);
		if (url.hostname == 'opensea.io') {
			let v = url.pathname.toLowerCase().split('/').filter(x => x);
			if (v[0] === 'assets' && v[1] === 'ethereum' && v[2] === ENS_NFT.toLowerCase() && /^\d+$/.test(v[3])) {
				resolve_btn.disabled = true;
				primary_arrows.classList.remove('hide');
				fetch(`https://metadata.ens.domains/mainnet/${ENS_NFT}/${v[3]}`).then(r => {
					if (r.status !== 200) throw new Error(`HTTP Error ${r.status}`);
					return r.json();
				}).then(meta => {
					let name = meta.is_normalized ? meta.name : meta.description.replace(/^.*ENS name\. \((.*\.eth).*$/, (_, x) => x); // cheap hack
					input_field.value = name;
					//skip_norm_check.checked = true;
					setTimeout(resolve, 0);
				}).catch(() => {}).finally(() => {
					resolve_btn.disabled = false;
				});
				return;
			}
		}
	} catch (err) {
	}
	if (!options.automatic && /^\s*[0-9a-f]{2,}(\s+[0-9a-f]{2,})+\s*$/i.test(input)) { // input convenience
		input_field.value = input = input.trim().split(/\s+/).map(x => `{${x}}`).join('');	
	}
	let title = 'ENS Resolver';
	if (!input) {
		if (window.location.hash) {
			window.history.pushState(null, null, ' ');
		} else {
			window.history.replaceState(null, null, ' ');
		}
		document.title = title;
		parse();
		return;
	}
	title += `: ${input}`;
	let hash = '#' + encodeURIComponent(input);
	if (options.skip_norm) {
		hash += SKIP_SUFFIX;
		title += ' (!)';
	}
	document.title = title;
	if (window.location.hash != hash) {
		window.history.pushState(null, null, hash);
	}
	if (!options.skip_norm && !parse()) {
		primary_arrows.classList.add('hide');
		return;
	}
	resolve_btn.disabled = true;
	primary_arrows.classList.remove('hide');
	resolve_date0 = new Date();
	resolve0(input, options.skip_norm).then(() => {
		resolve_btn.disabled = false;
		if (resolve_timer === RESOLVE_MODE_REPEAT) { 
			setTimeout(resolve, 0, resolve_options);
		} else {
			primary_arrows.classList.add('hide');
		}
	});
}


function create_elapsed() {
	let now = new Date();
	let delta = now - resolve_date0;
	if (delta < 1) return; // 0ms is stupid
	let span = document.createElement('span');
	span.classList.add('elapsed');
	span.innerHTML = format_dur(delta);
	resolve_date0 = now;
	return span;
}

async function resolve0(input0, skip_norm) {
	output_div.innerHTML = '';

	let input = replace_escapes(input0);
	let input_is_address = is_checksum_address(input);
	let input_row;
	let normed_row;
	let reverse_row;
	let name_norm;
	let norm_err;

	if (input_is_address) {
		input_row = create_row('Address');
		input_row.append(create_etherscan_address_link(input));
		add_row_tag(input_row, create_copy_btn(input));
		add_row_tag(input_row, create_reverse_resolve_btn(input));
		output_div.append(input_row);
		
		reverse_row = normed_row = create_row('Reverse', true);
		output_div.append(reverse_row);
		let primary, primary_err;
		try {
			primary = await active_provider.lookupAddress(input);
		} catch (err) {	
			primary_err = err;		
		} 
		remove_temporary(reverse_row);
		if (should_stop_resolving()) return;
		add_row_tag(reverse_row, create_elapsed());

		if (primary_err) {
			reverse_row.classList.add('error');
			add_row_tag(reverse_row, create_typed_tag('warn', primary_err));
			return;
		} else if (!primary) {
			add_row_tag(reverse_row, create_typed_tag('stop', 'Primary Not Set'));
			return;
		}

		make_exploded(reverse_row, primary, false);
		add_row_tag(reverse_row, create_copy_btn(primary));
		output_div.append(create_details_row(primary, true));
			
		try {
			name_norm = ens_normalize(primary);
		} catch (err) {
			reverse_row.classList.add('error');
			add_row_tag(reverse_row, create_typed_tag('warn', err));
			if (!skip_norm) return;
			name_norm = primary;
			norm_err = err;
		}
		if (!norm_err) {
			if (name_norm === primary) {
				add_row_tag(reverse_row, create_resolve_btn(primary));
				make_normalized(reverse_row);
			} else {
				add_row_tag(reverse_row, create_typed_tag('fail', 'Normalized'));
				let row = normed_row = create_row('Normalized Reverse');
				make_exploded(row, name_norm, true);
				add_row_tag(row, create_copy_btn(name_norm));
				add_row_tag(row, create_resolve_btn(name_norm));
				make_normalized(row);
				output_div.append(row);
				output_div.append(create_details_row(name_norm));
			}	
		}
	} else {
		
		// the input is a name
		input_row = normed_row = create_row(INPUT_NAME);
		input_row.classList.add('input');
		make_exploded(input_row, input, false);
		add_row_tag(input_row, create_ens_link(input));
		output_div.append(input_row);
		output_div.append(create_details_row(input, true));
		add_row_tag(input_row, create_copy_btn(input));

		if (!input.includes('.')) {
			add_row_tag(input_row, create_resolve_btn(`${input}.eth`, 'Use ".eth"'));
		}

		try {
			name_norm = ens_normalize(input);
		} catch (err) {
			input_row.classList.add('error');
			add_row_tag(input_row, create_typed_tag('warn', err));
			if (!skip_norm) return; // i think this is always true
			name_norm = input;
			norm_err = err;
		}	
		
		if (norm_err) {
			add_dot_eth_links(input_row, input);
		} else {
			if (name_norm === input) {
				make_normalized(input_row);
				add_dot_eth_links(input_row, input);
			} else  { 
				add_row_tag(input_row, create_typed_tag('fail', 'Normalized'));
				if (skip_norm) {
					name_norm = input;
				} else {
					add_transformed_row(input);
					let row = normed_row = create_row('Normalized');
					make_exploded(row, name_norm, true);
					make_normalized(row);
					add_row_tag(row, create_copy_btn(name_norm));
					add_row_tag(row, create_resolve_btn(name_norm));
					add_row_tag(row, create_ens_link(name_norm));
					add_dot_eth_links(row, name_norm);
					output_div.append(row);
					output_div.append(create_details_row(name_norm));
				}
			}
		}
	}

	let eth_label = get_dot_eth_label(name_norm);
	if (eth_label) {
		let tokens = ens_tokenize(eth_label);
		if (tokens.every(t => t.type === 'emoji')) {
			output_div.append(create_ethmoji_row(tokens));
		} else {
			let number = eth_label;
			let negative = number.startsWith('-');
			if (negative) number = number.slice(1);
			if (number) {
				let cps = explode_cp(number);
				let digits = cps.map(cp => DIGIT_MAP.get(cp));
				if (digits.every(x => x)) {
					let values = digits.map(x => x.i);
					let name0 = digits[0].name;
					if (digits.every(x => x.name === name0)) {
						//if (digits[0].reversed) values.reverse(); // LTR
						output_div.append(create_digits_row(name0, values, negative));
					} else {
						let first = digits[0].mixed;
						if (first && digits.every(x => x.mixed == first)) {
							let row = create_digits_row('Arabic', values, negative); //values.reverse()); // LTR
							add_row_tag(row, create_typed_tag('warn', 'Mixed Digits'));
							output_div.append(row);
						} else {
							let row = create_digits_row('Numeric', values, negative);
							add_row_tag(row, create_typed_tag('warn', 'Multiple Scripts'));
							output_div.append(row);
						}
					}
				}
			}
		}
	}

	if (!norm_err) {
		let pretty = ens_beautify(name_norm);
		let row = create_row(`Beautified`);
		row.classList.add('pretty');
		row.append(create_main_span(pretty));
		add_row_tag(row, create_copy_btn(pretty));
		if (input !== pretty) {
			add_row_tag(row, create_resolve_btn(pretty));
		}
		add_row_tag(row, create_pretty_tag());
		if (input === pretty) { 
			add_row_tag(input_row, create_pretty_tag());
			add_row_tag(row, create_typed_tag('good', 'Same as Input'));
		} else if (name_norm === pretty) {			
			add_row_tag(normed_row, create_pretty_tag());
			add_row_tag(row, create_typed_tag('good', 'Same as Norm'));
		}
		output_div.append(row);
	}

	output_div.append(create_dns_row(name_norm));

	// at this point, we have a name
	// lookup the name
	let resolver, resolver_err;
	let is_wildcard, wildcard_domain;
	let resolver_row = create_row('Resolver', true);
	output_div.append(resolver_row);
	try {
		resolver = await active_provider.getResolver(name_norm);
	} catch (err) {
		resolver_err = err;
	}
	remove_temporary(resolver_row);
	if (should_stop_resolving()) return;
	if (resolver) {
		is_wildcard = await resolver.supportsWildcard();
		if (should_stop_resolving()) return;
		if (is_wildcard) { 
			// ethers doesn't expose this information
			// https://github.com/ethers-io/ethers.js/issues/3398
			let v = name_norm.split('.');
			try {
				while (true) {
					let parent = v.join('.');
					let address = await registry_contract.callStatic.resolver(namehash(parent));
					if (should_stop_resolving()) return;
					if (address === resolver.address) {
						wildcard_domain = parent;
						break;
					}	
					v.shift();
				}
			} catch (ignored) {
			}
		}
	}
	add_row_tag(resolver_row, create_elapsed());
	
	if (resolver_err) {
		resolver_row.classList.add('error');
		add_row_tag(resolver_row, create_typed_tag('warn', resolver_err));
		return;	
	}
	
	// name doesn't exist
	if (resolver) { 
		resolver_row.append(create_etherscan_address_link(resolver.address, {contract: true}));
		if (is_wildcard) {
			add_row_tag(resolver_row, create_typed_tag('special', 'Wildcard'));
			if (wildcard_domain) {
				add_row_tag(resolver_row, wildcard_domain);
			} else {
				add_row_tag(resolver_row, create_typed_tag('warn', 'Unknown Parent'));
			}
		} else if (resolver.address === '0x4976fb03C32e5B8cfe2b6cCB31c09Ba78EBaBa41') {
			add_row_tag(resolver_row, create_typed_tag('good', 'Public Resolver'));
		} else {
			add_row_tag(resolver_row, create_typed_tag('second', 'Custom'));
		}
		add_row_tag(resolver_row, create_copy_btn(resolver.address));
	} else {
		add_row_tag(resolver_row, create_typed_tag('warn', `Name Not Found`));	
	}
	// check if *.eth	
	let available;	
	let check_nft;
	if (eth_label) {
		let hash = ethers.utils.id(eth_label);
		let avail_err;
		let t_exp;
		let len = [...eth_label].length;
		let avail_row = create_row('Availability', true);
		let premium;
		output_div.append(avail_row);
		try {
			await ensure_eth_nft();
			if (should_stop_resolving()) return;
			if (len >= 3) {
				available = await eth_nft_contract.callStatic.available(hash);
				if (should_stop_resolving()) return;
				t_exp = (await eth_nft_contract.callStatic.nameExpires(hash)).toNumber();
				if (available) {
					if (should_stop_resolving()) return;
					premium = await price_oracle_contract.callStatic.premium(eth_label, t_exp, 0);
				}
			}
		} catch (err) {
			avail_err = err;
		}
		remove_temporary(avail_row);
		if (should_stop_resolving()) return;
		add_row_tag(avail_row, create_elapsed()); 
		add_row_tag(avail_row, create_length_span(len));

		if (avail_err) {
			avail_row.classList.add('error');
			add_row_tag(avail_row, create_typed_tag('warn', avail_err));
		} else if (available === undefined) {
			add_row_tag(avail_row, create_typed_tag('fail', `Too Short`));
			let padded = Array(Math.max(1, 4 - len)).fill(eth_label).join('');
			add_row_tag(avail_row, create_resolve_btn(`${padded}.eth`, 'Repeat until 3+'));
		} else if (available) {
			let btn = document.createElement('button');
			btn.innerHTML = 'üëåÔ∏è Available to Register';
			btn.style.outline = '3px solid #afa';
			btn.addEventListener('click', () => create_ens_link(name_norm).click());
			add_row_tag(avail_row, btn);
			let ether = parseFloat(ethers.utils.formatEther(premium));
			if (ether) {
				add_row_tag(avail_row, create_typed_tag('warn', `${ether.toFixed(2)} ETH Premium`));
			}
			//add_row_tag(avail_row, create_typed_tag('fire', 'Available'));
			//add_row_tag(avail_row, create_ens_link(name_norm, {title: 'Register'}));
		} else {
			let date = new Date(1000 * t_exp);
			check_nft = hash; 
			let t_end = t_exp + eth_nft_contract.grace_period;
			let t_now = Math.round(Date.now() / 1000);
			if (t_now >= t_exp && t_now <= t_end) {
				let days = (t_end - t_now) / 86400;
				add_row_tag(avail_row, create_typed_tag('warn', `Grace period (${format_dur(1000 * eth_nft_contract.grace_period)}) ends in ${format_dur(1000 * (t_end - t_now))}`));
			} else {
				let span_reg = document.createElement('span');
				span_reg.innerText = `‚úçÔ∏è Registered until ${date.toLocaleDateString()}`;
				span_reg.style.backgroundColor = '#def';
				add_row_tag(avail_row, span_reg);
				if (t_exp - t_now < 86400 * 30) {
					add_row_tag(avail_row, create_typed_tag('warn', `Expires in ${format_dur(1000 * (t_exp - t_now))}`));
				} else {
					span_reg.innerHTML += ` (${format_dur(1000 * (t_exp - t_now))})`;
				}
			}
		}
		add_row_tag(avail_row, create_etherscan_address_link(eth_nft_contract.address, {title: 'Contract', contract: true}));

		/*
		if (check_nft) {
			let nft_row = create_row(`NFT Owner`, true);
			output_div.append(nft_row);
			let nft_owner, nft_error;
			try {
				nft_owner = await eth_nft_contract.callStatic.ownerOf(hash);	
			} catch (err) {
				nft_error = err;
			}
			if (should_stop_resolving()) return;
			remove_temporary(nft_row);
			add_row_tag(nft_row, create_elapsed());
			if (nft_error) {
				nft_row.classList.add('error');
				add_row_tag(nft_row, create_typed_tag('warn', nft_error));
			} else {
				nft_row.append(create_etherscan_address_link(nft_owner));
				add_row_tag(nft_row, create_copy_btn(nft_owner));
				add_row_tag(nft_row, create_resolve_btn(nft_owner));
			}
		}
		*/
	}			
	//	return;
	//}

	
	// get the owner
	let owner;
	if (!is_wildcard) {
		// there doesn't seem to be an "owner"
		//owner = await resolver._fetch('0x02571be3'); // owner(bytes32)
		//owner = await resolver._fetch('0x38a699a4'); // exists(bytes32)
		//owner = await resolver._fetch('0x7dd56411'); // ownerOf(bytes32)
		let owner_row = create_row(available ? 'Previous Owner' : 'Owner', true);
		let owner_err;
		output_div.append(owner_row);
		try {
			owner = await registry_contract.callStatic.owner(namehash(name_norm));
			if (should_stop_resolving()) return;
			if (is_null_hex(owner)) owner = false;
			if (!owner && check_nft) {
				owner = await eth_nft_contract.callStatic.ownerOf(check_nft);
				if (is_null_hex(owner)) owner = false;
			}
		} catch (err) {
			owner_err = err;
		}
		remove_temporary(owner_row);
		if (should_stop_resolving()) return;
		add_row_tag(owner_row, create_elapsed());

		if (owner_err) {
			owner_row.classList.add('error');
			owner_row.append(create_typed_tag('warn', owner_err));
		} else if (!owner) {
			add_row_tag(owner_row, create_typed_tag('good', 'None'));
		} else {
			
			owner_row.classList.add(available ? 'old' : 'owner');
			owner_row.append(create_etherscan_address_link(owner));
			add_row_tag(owner_row, create_copy_btn(owner));
			//owner_row.classList.toggle('old', available);
			// if the input was an address, we can validate
			if (input_is_address) {
				add_row_tag(reverse_row, create_typed_tag(owner === input ? 'good' : 'fail', 'Owned'));
				if (owner === input) {
					add_row_tag(owner_row, 'Same as Input');
				}
			}
			if (owner !== input) {
				add_row_tag(owner_row, create_resolve_btn(owner));
			}

			if (eth_label) {
				let cont_row = create_row(`Controller`, true);
				output_div.append(cont_row);
				let cont;
				try {
					await ensure_eth_nft();
					cont = await eth_nft_contract.callStatic.getApproved(labelhash(eth_label));
					if (is_null_hex(cont)) cont = false;
				} catch (err) {				
				}
				if (should_stop_resolving()) return;
				if (cont) {
					cont_row.append(create_etherscan_address_link(cont));
					add_row_tag(cont_row, create_elapsed());
					remove_temporary(cont_row);
					cont_row.classList.toggle('old', !!available);
				} else {
					cont_row.remove();
				}
			}
		}
	}

	// add address
	let address;
	if (resolver) {
		let address_err;
		let address_row = create_row(`ETH Address`, true);
		address_row.classList.add(available ? 'old' : 'addr');
		output_div.append(address_row);	
		try {
			address = await resolver.getAddress();
			if (is_null_hex(address)) address = false;
		} catch (err) {
			address_err = err;
		}
		remove_temporary(address_row);
		if (should_stop_resolving()) return;
		if (address_err) {
			address_row.classList.add('error');
			add_row_tag(address_row, create_typed_tag('warn', address_err));
		} else if (!address) {
			add_row_tag(address_row, create_typed_tag('warn', 'Not Set'));
		} else {
			address_row.append(create_etherscan_address_link(address));
			if (input_is_address) {
				if (address === input) {
					add_row_tag(input_row, create_typed_tag('fire', 'Primary'));
					add_row_tag(address_row, 'Same as Input');
				} else if (address) {
					add_row_tag(address_row, create_copy_btn(address));
					add_row_tag(address_row, create_resolve_btn(address));
					add_row_tag(address_row, create_typed_tag('warn', 'Different from Owner'));	
				}
			} else {
				if (owner === address) {
					add_row_tag(address_row, create_typed_tag('good', 'Same as Owner'));	
				} else {
					add_row_tag(address_row, create_copy_btn(address));
					add_row_tag(address_row, create_resolve_btn(address));
					if (owner) {
						//add_row_tag(address_row, create_typed_tag('warn', 'Not Owner'));	
						add_row_tag(address_row, create_typed_tag('fail', 'Owner'));	
					}
				}
				add_row_tag(address_row, create_link(`https://opensea.io/${address}?tab=collected`, OPENSEA_NAME));
				add_row_tag(address_row, create_link(`https://rainbow.me/${address}`, 'Rainbow'));	
			}
		}
		add_row_tag(address_row, create_elapsed());	
	}

	if (input_is_address || !address) return; // nothing more to do

	// lookup primary from eth address 
	let primary, primary_err;
	let primary_row = create_row('Primary', true);
	output_div.append(primary_row);
	try {
		primary = await active_provider.lookupAddress(address);
	} catch (err) {
		primary_err = err;
	}
	remove_temporary(primary_row);
	if (should_stop_resolving()) return;
	add_row_tag(primary_row, create_elapsed());
	
	primary_row.classList.toggle('old', !!available);
	

	if (primary_err) {
		primary_row.classList.add('error');
		add_row_tag(primary_row, create_typed_tag('warn', primary_err));
		return;
	}
	if (!primary) {
		add_row_tag(primary_row, create_typed_tag('warn', 'Not Set'));
		return;
	}



	// primary exists
	make_exploded(primary_row, primary, false);

	// lets check if it's normalized
	let primary_norm;
	try {
		primary_norm = ens_normalize(primary);
	} catch (err) {
		primary_row.classList.add('error');
		add_row_tag(primary_row, create_typed_tag('warn', err));
	}

	if (primary === input) {
		add_row_tag(primary_row, 'Same as Input');
	} else if (primary === name_norm) {		
		add_row_tag(primary_row, 'Same as Norm');
	} else {
		add_row_tag(primary_row, create_resolve_btn(primary));
		let details_row = create_details_row(primary, true);
		details_row.classList.toggle('old', !!available);
		output_div.append(details_row);
	}

	
	// primary was normalized
	if (primary === primary_norm) {
		make_normalized(primary_row);
		if (name_norm !== primary_norm) {
			add_row_tag(primary_row, create_copy_btn(primary_norm));
			add_row_tag(primary_row, create_resolve_btn(primary_norm));
			add_row_tag(primary_row, create_ens_link(primary_norm));
			add_dot_eth_links(primary_row, primary_norm);
		}

	// primary was valid but not normalized
	} else if (primary_norm) {
		add_row_tag(primary_row, create_typed_tag('fail', 'Normalized'));
		// create norm row
		let row = create_row('Normalized Primary');
		row.classList.toggle('old', !!available);
		make_exploded(row, primary_norm, true);
		make_normalized(row);
		add_row_tag(row, create_copy_btn(primary_norm));
		add_row_tag(row, create_ens_link(primary_norm));
		add_dot_eth_links(row, primary_norm);
		if (name_norm !== primary_norm) {
			add_row_tag(row, create_resolve_btn(primary_norm));
		}
		output_div.append(row);
		let details_row = create_details_row(primary_norm);
		details_row.classList.toggle('old', !!available);
		output_div.append(details_row);
	}	

	if (primary_norm && name_norm === primary_norm) {
		if (owner === address) {
			add_row_tag(normed_row, create_typed_tag('fire', 'Primary Owner'));
		} else {
			add_row_tag(normed_row, create_typed_tag('good', 'Primary'));
		}
	}
}

async function ensure_eth_nft() {
	if (eth_nft_contract) return;
	// https://docs.ens.domains/contract-api-reference/.eth-permanent-registrar
	let resolver = await active_provider.getResolver('eth');
	if (!resolver) throw new Error(`No .eth resolver`);
	let resolver_contract = new ethers.Contract(resolver.address, [
		'function interfaceImplementer(bytes32 node, bytes4 interfaceID) external view returns (address)'
	], active_provider);
	eth_nft_contract = new ethers.Contract(await resolver.getAddress(), [
		'function available(uint256 id) external view returns(bool)',
		'function nameExpires(uint256 id) external view returns(uint256)',
		'function ownerOf(uint256 id) external view returns (address)',
		'function getApproved(uint256 id) external view returns (address)',
		'function GRACE_PERIOD() external view returns (uint256)',
	], active_provider);
	eth_nft_contract.grace_period = (await eth_nft_contract.callStatic.GRACE_PERIOD()).toNumber();
	let controller_address = await resolver_contract.callStatic.interfaceImplementer(namehash(resolver.name), '0x018fac06');
	// https://etherscan.io/address/0x283Af0B28c62C092C9727F1Ee09c02CA627EB7F5#code
	let price_oracle_address = await active_provider.getStorageAt(controller_address, 2);
	price_oracle_contract = new ethers.Contract('0x' + price_oracle_address.slice(-40), [
		'function premium(string calldata name, uint256 expires, uint256 duration) external view returns (uint256)',
	], active_provider);
}

function is_checksum_address(s) {
	try {
		return s === ethers.utils.getAddress(s);
	} catch (ignored) {		
	}
}
function is_null_hex(s) {
	return /^0x0*$/.test(s);
}
function labelhash(s) {
	return ethers.utils.id(s);
}
function namehash(s) {
	let hash = '0x0000000000000000000000000000000000000000000000000000000000000000';
	if (s) hash = s.split('.').reduceRight((h, x) => ethers.utils.keccak256(h + ethers.utils.id(x).slice(2)), hash);
	return hash.slice(0, 66);
}

function read_local_storage(key, fn) {
	let stored = window.localStorage.getItem(key);
	if (stored === null) return;
	try {
		fn(JSON.parse(stored));
	} catch (err) {	
	}
}
</script>
</body>
</html>
